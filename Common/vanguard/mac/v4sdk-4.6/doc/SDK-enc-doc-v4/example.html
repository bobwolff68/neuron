<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    <LINK HREF="style.css" REL="stylesheet" TYPE="text/css">
</head>
    <BODY BGCOLOR="#FFFFFF">

	<a href="http://www.vsofts.com/" target="top">
		<img src="vssh-codec-logo.gif" border="none">
	</a>
	<p style="margin-top: 0px; font-size: smaller;">
		<a href="main.html" style="text-decoration:none; color: #252E78; ">
		VSS H.264 Encoder SDK v4
		</a>
	</p>
<!-- header.html -->

<!-- Generated by Doxygen 1.5.6 -->
<div class="contents">
<h1><a class="anchor" name="example">Sample Encoder </a></h1>This code sample (sample_enc.c) demonstrates typical usage of VSS H.264 Encoder SDK. It shows how to encode video frames, how to configure encoder library to satisfy specific application needs, how to handle exceptions and manage memory resources.<p>
Encoder sample application is designed to compress raw video and write H.264 Annex B compliant video stream to the output file. <div class="fragment"><pre class="fragment">
<span class="preprocessor">#define _CRT_SECURE_NO_DEPRECATE //to avoid warning C4996: 'fopen' was declared deprecated</span>
<span class="preprocessor"></span>
<span class="comment">// codec headers</span>
<span class="preprocessor">#include "<a class="code" href="v4e__api_8h.html" title="Encoder public API.">v4e_api.h</a>"</span>
<span class="preprocessor">#include "<a class="code" href="vp_8h.html" title="VSofts Video Processing Library public API.">vp.h</a>"</span>

<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;time.h&gt;</span>
<span class="preprocessor">#ifdef WIN32</span>
<span class="preprocessor"></span><span class="preprocessor">#include &lt;windows.h&gt;</span>
<span class="preprocessor">#else</span>
<span class="preprocessor"></span><span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#include &lt;assert.h&gt;</span>

<span class="comment">// enable CRT debug for memory leak detection etc. (available under Windows only)</span>
<span class="preprocessor">#if defined(WIN32) &amp;&amp; defined(DEBUG) &amp;&amp; !defined(__GNUC__)</span>
<span class="preprocessor"></span><span class="preprocessor">#define _CRT_DEBUG_</span>
<span class="preprocessor"></span><span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#ifdef _CRT_DEBUG_</span>
<span class="preprocessor"></span><span class="preprocessor">    #include &lt;crtdbg.h&gt;</span>
<span class="comment">//  #include &lt;vld.h&gt;</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#include "<a class="code" href="v4timer_8h.html" title="high resolution timer">v4timer.h</a>"</span>
<span class="preprocessor">#include "<a class="code" href="v4info_8h.html" title="Codec information access example.">v4info.h</a>"</span>
<span class="preprocessor">#include "<a class="code" href="v4args_8h.html" title="command line arguments parsing routines">v4args.h</a>"</span>
<span class="preprocessor">#include "<a class="code" href="v4file_8h.html" title="file i/o operations verbose output support">v4file.h</a>"</span>

<span class="comment">/*</span>
<span class="comment">please do not forget to specify properly following parameters in encoder config file:</span>
<span class="comment">input.width</span>
<span class="comment">input.height</span>
<span class="comment">input.colorspace</span>
<span class="comment">input.sample_size</span>
<span class="comment">input.significant_bits</span>
<span class="comment">*/</span>


<span class="preprocessor">#define MAX_FILE_NAME 1024</span>
<span class="preprocessor"></span>
<span class="preprocessor">#define MAX_NUM_VIEWS 4  //maximum number of views in MVC encoding</span>
<span class="preprocessor"></span><span class="keywordtype">char</span> *input_files_mvc[MAX_NUM_VIEWS-1] = {NULL};
FILE *files_mvc[MAX_NUM_VIEWS-1] = {NULL};

<span class="keywordtype">char</span> *input_file  = NULL;
<span class="keywordtype">char</span> *output_file = NULL;
<span class="keywordtype">char</span> *config_file = NULL;
<span class="keywordtype">char</span> *cc_file = NULL;   <span class="comment">// CC file name</span>
<span class="keywordtype">char</span> *pd_file = NULL;   <span class="comment">// PD file name</span>

<span class="keywordtype">char</span> *ext_data_string = NULL;

<span class="keywordtype">char</span> output_file_ms[MAX_FILE_NAME];

<span class="keywordtype">int</span> frame_width  = 0;
<span class="keywordtype">int</span> frame_height = 0;
<span class="keywordtype">int</span> colorspace   = -1;
<span class="keywordtype">int</span> frame_rate   = 0;   <span class="comment">// frame rate (frames per 10000 seconds)</span>
<span class="keywordtype">int</span> frame_skip   = 0;   <span class="comment">// skip every N-th frame on input</span>
<span class="keywordtype">int</span> max_frames   = 0;   <span class="comment">// zero means to handle all the frames</span>
<span class="keywordtype">int</span> frame_start = 0;    <span class="comment">// first frame number to encode</span>
<span class="keywordtype">int</span> bitrate      = 0;
<span class="keywordtype">int</span> mt           = -1;
<span class="keywordtype">int</span> forever      = 0;   <span class="comment">// run forever</span>
<span class="keywordtype">int</span> use_async_feed = 0; <span class="comment">// enable asynchronous encoder input</span>
<span class="keywordtype">int</span> use_async_receive = 0;  <span class="comment">// enable asynchronous NAL receive via callback</span>
<span class="keywordtype">int</span> use_frame_modifier = 0;
<span class="keywordtype">int</span> change_bitrate_period = 0;  <span class="comment">// every N-th frame</span>
<span class="keywordtype">int</span> change_bitrate_ratio = 100; <span class="comment">// 100:1, i.e. 120 means 1.2</span>
<span class="keywordtype">int</span> num_dep_views = 0;  <span class="comment">// number of dependent views in MVC coding</span>
<span class="keywordtype">int</span> bits_per_pel = 0;   <span class="comment">// 0 means not assigned, [8..14]</span>
<span class="keywordtype">int</span> fp_type = -1; <span class="comment">//frame packing type; -1 - means not used; only side-by-side (3) or top-bottom(4) implemented</span>
<span class="keywordtype">int</span> use_preload = 0;
<span class="keywordtype">int</span> frame_num = 0;
<span class="keywordtype">int</span> rgb_switch = 0;

<span class="comment">// additional file manipulators</span>
FILE *file_cc  = NULL;
FILE *file_pd  = NULL;

<span class="comment">// Multi-stream mode output file pointers</span>
FILE *file_ms[<a class="code" href="v4__types_8h.html#3bd149976fc443d2734093ae6b7ad6a7" title="Maximum number of AVC streams in multistream encoding mode.">MAX_AVC_STREAMS</a>] = {NULL};

<span class="comment">// Number of streams in multi-stream mode</span>
<span class="keywordtype">int</span> num_ms_streams = 0;
<span class="keywordtype">int</span> is_write_general_output = 1;

<span class="comment">// public variables for receive callback access:</span>
<span class="keywordtype">int</span> total_samples = 0;
<span class="keywordtype">int</span> eos = 0;
uint64_t total_bytes = 0;

<span class="keyword">static</span> <a class="code" href="structcmd__arg__t.html">cmd_arg_t</a> all_args[] =
{
    { <span class="stringliteral">"i"</span>, <span class="stringliteral">"yf"</span>, <span class="stringliteral">"input-file"</span>,   1, &amp;input_file,  0, <span class="stringliteral">"name of input raw YUV file"</span> },
    { <span class="stringliteral">"-"</span>, <span class="stringliteral">"y1"</span>, <span class="stringliteral">"view-1-file"</span>,  1, &amp;input_files_mvc[0],  0, <span class="stringliteral">"name of input raw YUV for view 1"</span> },
    { <span class="stringliteral">"-"</span>, <span class="stringliteral">"y2"</span>, <span class="stringliteral">"view-2-file"</span>,  1, &amp;input_files_mvc[1],  0, <span class="stringliteral">"name of input raw YUV for view 2"</span> },
    { <span class="stringliteral">"-"</span>, <span class="stringliteral">"y3"</span>, <span class="stringliteral">"view-3-file"</span>,  1, &amp;input_files_mvc[2],  0, <span class="stringliteral">"name of input raw YUV for view 3"</span> },
    { <span class="stringliteral">"o"</span>, <span class="stringliteral">"hf"</span>, <span class="stringliteral">"output-file"</span>,  1, &amp;output_file, 0, <span class="stringliteral">"name of output H.264 file"</span> },
    { <span class="stringliteral">"c"</span>, <span class="stringliteral">"cf"</span>, <span class="stringliteral">"config-file"</span>,  1, &amp;config_file, 0, <span class="stringliteral">"name of encoder config file"</span> },
    { <span class="stringliteral">"-"</span>, <span class="stringliteral">"cc"</span>, <span class="stringliteral">"cc-file"</span>,      1, &amp;cc_file,     0, <span class="stringliteral">"name of input CC text file (one line per frame)"</span> },
    { <span class="stringliteral">"-"</span>, <span class="stringliteral">"pd"</span>, <span class="stringliteral">"pd-file"</span>,      1, &amp;pd_file,     0, <span class="stringliteral">"name of input private data text file (one line per frame)"</span> },
    { <span class="stringliteral">"w"</span>, <span class="stringliteral">"fw"</span>, <span class="stringliteral">"frame-width"</span>,  0, &amp;frame_width, 0, <span class="stringliteral">"input frame width, pixels (divisible by 2)"</span> },
    { <span class="stringliteral">"h"</span>, <span class="stringliteral">"fh"</span>, <span class="stringliteral">"frame-height"</span>, 0, &amp;frame_height,0, <span class="stringliteral">"input frame height, pixels (divisible by 2)"</span> },
    { <span class="stringliteral">"f"</span>, <span class="stringliteral">"fr"</span>, <span class="stringliteral">"frame-rate"</span>,   0, &amp;frame_rate,  0, <span class="stringliteral">"input frame rate (frames per 10,000 sec)"</span> },
    { <span class="stringliteral">"-"</span>, <span class="stringliteral">"fs"</span>, <span class="stringliteral">"frame-start"</span>,  0, &amp;frame_start, 0, <span class="stringliteral">"first frame number to encode"</span> },
    { <span class="stringliteral">"k"</span>, <span class="stringliteral">"fk"</span>, <span class="stringliteral">"frame-skip"</span>,   0, &amp;frame_skip,  0, <span class="stringliteral">"encode every N-th frame (numbering starts from zero)"</span> },
    { <span class="stringliteral">"n"</span>, <span class="stringliteral">"fn"</span>, <span class="stringliteral">"frame-count"</span>,  0, &amp;max_frames,  0, <span class="stringliteral">"max number of input frames to process"</span> },
    { <span class="stringliteral">"u"</span>, <span class="stringliteral">"fc"</span>, <span class="stringliteral">"colorspace"</span>,   0, &amp;colorspace,  0, <span class="stringliteral">"colorspace: 0=IYUV,I420; 1=YV12; 2=YUYV,YUY2; 3=YVYU; 4=UYVY; 5=RGB555; 6=RGB565; 7=RGB24; 8=RGB32, 9=4:0:0, 10=4:2:2"</span> },
    { <span class="stringliteral">"-"</span>, <span class="stringliteral">"fb"</span>, <span class="stringliteral">"bits-per-pel"</span>, 0, &amp;bits_per_pel,0, <span class="stringliteral">"input frame: bits per pixel (8..14)"</span> },
    { <span class="stringliteral">"b"</span>, <span class="stringliteral">"br"</span>, <span class="stringliteral">"bitrate"</span>,      0, &amp;bitrate,     0, <span class="stringliteral">"desired bitrate, kbps"</span> },
    { <span class="stringliteral">"m"</span>, <span class="stringliteral">"mt"</span>, <span class="stringliteral">"threads"</span>,      0, &amp;mt,         -1, <span class="stringliteral">"number of threads (-1=auto, 0=disable)"</span> },
    { <span class="stringliteral">"v"</span>, <span class="stringliteral">"vb"</span>, <span class="stringliteral">"verbose"</span>,      0, &amp;<a class="code" href="v4file_8h.html#0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>,     1, <span class="stringliteral">"level of verbose messages (0/1/2)"</span> },
    { <span class="stringliteral">"-"</span>, <span class="stringliteral">"fv"</span>, <span class="stringliteral">"forever"</span>,      0, &amp;forever,    -1, <span class="stringliteral">"rewind input stream and run N loops"</span> },
    { <span class="stringliteral">"-"</span>, <span class="stringliteral">"--"</span>, <span class="stringliteral">"async-feed"</span>,   0, &amp;use_async_feed,    1, <span class="stringliteral">"use asynchronous data feed (0/1)"</span> },
    { <span class="stringliteral">"-"</span>, <span class="stringliteral">"--"</span>, <span class="stringliteral">"async-receive"</span>,0, &amp;use_async_receive, 1, <span class="stringliteral">"use asynchronous data receive (0/1)"</span> },
    { <span class="stringliteral">"-"</span>, <span class="stringliteral">"--"</span>, <span class="stringliteral">"preload"</span>,      0, &amp;use_preload, -1, <span class="stringliteral">"preload N frames on input"</span> },
    { <span class="stringliteral">"-"</span>, <span class="stringliteral">"--"</span>, <span class="stringliteral">"change-bitrate-period"</span>, 0, &amp;change_bitrate_period, 30, <span class="stringliteral">"change bitrate period (every N-th frame)"</span> },
    { <span class="stringliteral">"-"</span>, <span class="stringliteral">"--"</span>, <span class="stringliteral">"change-bitrate-ratio"</span>,  0, &amp;change_bitrate_ratio, 100, <span class="stringliteral">"change bitrate ratio, 100:1 (125=1.25)"</span> },
    { <span class="stringliteral">"-"</span>, <span class="stringliteral">"fp"</span>, <span class="stringliteral">"fp-type"</span>,       0, &amp;fp_type,   3, <span class="stringliteral">"use side-by-side(3) or top-bottom(4) frame packing"</span> },
    { <span class="stringliteral">"-"</span>, <span class="stringliteral">"ed"</span>, <span class="stringliteral">"ext_data_string"</span>,  1, &amp;ext_data_string, 0, <span class="stringliteral">"extra data string (use \" \" for string with spaces)"</span> },
};
<span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> all_args_cnt = <span class="keyword">sizeof</span>(all_args)/<span class="keyword">sizeof</span>(all_args[0]);


<span class="keyword">typedef</span> <span class="keyword">struct </span>raw_frame_ex_t
{
    <a class="code" href="structvp__raw__frame__t.html" title="structure holding external image and it&amp;#39;s characteristics">vp_raw_frame_t</a> vp_views[MAX_NUM_VIEWS];
    <span class="keywordtype">int</span> num_views;
    <span class="keywordtype">int</span> busy;
} raw_frame_ex_t;

<span class="keywordtype">int</span> num_raw_frames = 1;
raw_frame_ex_t      raw_frames[<a class="code" href="v4e__api_8h.html#12651221ee1bba21d9c76a002065b45b" title="for backward compatibility">NUM_RGB_FRAMES</a>] = {0};
<a class="code" href="structvp__frame__factory__t.html" title="frame factory instance">vp_frame_factory_t</a>  vpfactory[MAX_NUM_VIEWS] = {0};

<span class="comment">// preload support</span>
<span class="keywordtype">int</span> preload_frames = 0;
<a class="code" href="structvp__frame__t.html" title="frame specification">vp_frame_t</a> *preload_buffer[MAX_NUM_VIEWS] = {NULL};

<span class="keyword">static</span> <span class="keywordtype">void</span> usage(<span class="keywordtype">void</span>)
{
    verbose_print(0, <span class="stringliteral">"USAGE:\n"</span>);
    verbose_print(0, <span class="stringliteral">"\t &gt; sample_enc [-option value] [param=value]\n"</span>);
    verbose_print(0, <span class="stringliteral">"WHERE:\n"</span>);
}

<span class="keyword">static</span> <span class="keywordtype">int</span> openFiles(<span class="keywordtype">void</span>)
{
    <span class="keywordtype">int</span> rc, i, num_extra_files;
    rc = open_std_files(input_file, output_file);
    <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> rc;

    num_extra_files = num_dep_views;

    <span class="keywordflow">for</span> (i = 0; i &lt; num_extra_files; i++)
    {
        <span class="keywordflow">if</span> (input_files_mvc[i] == NULL)
        {
            verbose_print(0, <span class="stringliteral">"Error: input dependent view-%d file not specified\n"</span>, i+1);
            <span class="keywordflow">return</span> -1;
        }
        files_mvc[i] = fopen(input_files_mvc[i], <span class="stringliteral">"rb"</span>);
        <span class="keywordflow">if</span> (files_mvc[i] == NULL)
        {
            verbose_print(0, <span class="stringliteral">"Error: can't open input file [%s]\n"</span>, input_files_mvc[i]);
            <span class="keywordflow">return</span> -1;
        }
    }
    <span class="keywordflow">if</span> (cc_file)
    {
        file_cc = fopen(cc_file, <span class="stringliteral">"rt"</span>);
        <span class="keywordflow">if</span> (file_cc == NULL)
        {
            verbose_print(0, <span class="stringliteral">"Warning: can't open CC file [%s]\n"</span>, cc_file);
        }
    }
    <span class="keywordflow">if</span> (pd_file)
    {
        file_pd = fopen(pd_file, <span class="stringliteral">"rt"</span>);
        <span class="keywordflow">if</span> (file_pd == NULL)
        {
            verbose_print(0, <span class="stringliteral">"Warning: can't open PD file [%s]\n"</span>, pd_file);
        }
    }
    <span class="keywordflow">return</span> 0;
}

<span class="keyword">static</span> <span class="keywordtype">void</span> seekFile(<span class="keywordtype">int</span> num_frames, <span class="keywordtype">int</span> image_size)
{
    <span class="keywordtype">int</span> step = (1&lt;&lt;30)/image_size;
    <span class="keywordtype">int</span> i, steps = num_frames/step;
    <span class="comment">// skip frames using max allowed steps</span>
    <span class="keywordflow">for</span>(i=0;i&lt;steps;i++)
    {
        fseek(<a class="code" href="v4file_8h.html#15c1ffab0926c9d750ff119cca0285b0">file_in</a>, image_size*step, SEEK_CUR);
    }
    <span class="comment">// skip remaining frames</span>
    fseek(<a class="code" href="v4file_8h.html#15c1ffab0926c9d750ff119cca0285b0">file_in</a>, image_size*(num_frames-steps*step), SEEK_CUR);
}

<span class="keyword">static</span> <span class="keywordtype">int</span> readFile(<span class="keywordtype">void</span> *buf, <span class="keywordtype">int</span> buf_size)
{
    <span class="keywordflow">return</span> read_input_file(buf, buf_size);
}

<span class="keyword">static</span> <span class="keywordtype">int</span> writeFile(<span class="keywordtype">void</span> *buf, <span class="keywordtype">int</span> buf_size)
{
    <span class="keywordflow">return</span> write_output_file(buf, buf_size);
}

<span class="keyword">static</span> <span class="keywordtype">void</span> closeFiles(<span class="keywordtype">void</span>)
{
    <span class="keywordtype">int</span> i;
    close_std_files();
    <span class="keywordflow">if</span> (file_cc  != NULL) fclose(file_cc);
    <span class="keywordflow">if</span> (file_pd  != NULL) fclose(file_pd);
    <span class="keywordflow">for</span> (i = 0; i &lt; num_dep_views; i++)
    {
        fclose(files_mvc[i]);
    }
}

<span class="keyword">static</span> <span class="keywordtype">char</span> *readCC(<span class="keywordtype">char</span> *buf, <span class="keywordtype">int</span> buf_size)
{
    <span class="keywordflow">if</span> (file_cc == NULL) <span class="keywordflow">return</span> NULL;
    <span class="keywordflow">return</span> fgets(buf, buf_size, file_cc);
}

<span class="keyword">static</span> <span class="keywordtype">char</span> *readPD(<span class="keywordtype">char</span> *buf, <span class="keywordtype">int</span> buf_size)
{
    <span class="keywordflow">if</span> (file_pd == NULL) <span class="keywordflow">return</span> NULL;
    <span class="keywordflow">return</span> fgets(buf, buf_size, file_pd);
}

<span class="comment">// Multi-stream mode support</span>

<span class="keyword">static</span> <span class="keywordtype">int</span> multistream_init(<a class="code" href="structv4e__settings__t.html" title="All encoder settings.">v4e_settings_t</a> *s)
{
    <span class="keywordtype">int</span> i;
    <span class="keywordtype">char</span> ms_common[MAX_FILE_NAME];

    <span class="keywordflow">if</span> (s-&gt;<a class="code" href="structv4e__settings__t.html#0eb9ab59c4fc040a3d4710b5ccfe617d" title="svc encoding settings">svc</a>.<a class="code" href="structsvc__settings__t.html#b9a25fb28ebf4cce9e1d69d9f2ea52b7" title="number of svc-layers (0 means no SVC)">num_layers</a> &lt;= 0) <span class="keywordflow">return</span> 0;

    <span class="comment">// Select general output file using or not</span>
    <span class="keywordflow">switch</span> (s-&gt;<a class="code" href="structv4e__settings__t.html#0eb9ab59c4fc040a3d4710b5ccfe617d" title="svc encoding settings">svc</a>.<a class="code" href="structsvc__settings__t.html#408e8588246f8a76c37050f56695297b">multistream_mode</a>)
    {
    <span class="keywordflow">case</span> <a class="code" href="v4e__settings_8h.html#73683698f52b7fac59e9fa6cb29699a71d5b55cd95b04c2ec8cf10bd63b59e12" title="AVC - generate several AVC streams.">MULTISTREAM_MODE_AVC</a>:
        is_write_general_output = 0;
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> <a class="code" href="v4e__settings_8h.html#73683698f52b7fac59e9fa6cb29699a707978eefce87eb9a860050a53491ff58" title="MVC - generate MVC stream.">MULTISTREAM_MODE_MVC</a>:
        is_write_general_output = 1;
        <span class="keywordflow">break</span>;
    <span class="keywordflow">default</span>:
        is_write_general_output = 1;
    }

    num_ms_streams = ( (s-&gt;<a class="code" href="structv4e__settings__t.html#0eb9ab59c4fc040a3d4710b5ccfe617d" title="svc encoding settings">svc</a>.<a class="code" href="structsvc__settings__t.html#408e8588246f8a76c37050f56695297b">multistream_mode</a> == <a class="code" href="v4e__settings_8h.html#73683698f52b7fac59e9fa6cb29699a71d5b55cd95b04c2ec8cf10bd63b59e12" title="AVC - generate several AVC streams.">MULTISTREAM_MODE_AVC</a>) || (s-&gt;<a class="code" href="structv4e__settings__t.html#0eb9ab59c4fc040a3d4710b5ccfe617d" title="svc encoding settings">svc</a>.<a class="code" href="structsvc__settings__t.html#408e8588246f8a76c37050f56695297b">multistream_mode</a> == <a class="code" href="v4e__settings_8h.html#73683698f52b7fac59e9fa6cb29699a707978eefce87eb9a860050a53491ff58" title="MVC - generate MVC stream.">MULTISTREAM_MODE_MVC</a>)) ? 
        s-&gt;<a class="code" href="structv4e__settings__t.html#0eb9ab59c4fc040a3d4710b5ccfe617d" title="svc encoding settings">svc</a>.<a class="code" href="structsvc__settings__t.html#b9a25fb28ebf4cce9e1d69d9f2ea52b7" title="number of svc-layers (0 means no SVC)">num_layers</a> + 1 : 0;
    
    <span class="keywordflow">if</span>(num_ms_streams == 1)
    {
        num_ms_streams = 0;
        verbose_print(0, <span class="stringliteral">"*** Warning: multi-stream mode is disabled: use 'svc.num_layers' &gt; 0\n"</span>);
    }
    
    <span class="keywordflow">if</span>(num_ms_streams &lt; 2)
    {
        <span class="keywordflow">return</span> 0;
    }

    <span class="keywordflow">if</span>(output_file_ms[0] == 0)
    {
        <span class="keywordflow">return</span> 0;
    }

    <span class="comment">// Prepare file name's common part</span>
    strcpy(ms_common, output_file_ms);
    <span class="comment">// Remove file extension (if exists)</span>
    <span class="keywordflow">for</span>(i = (<span class="keywordtype">int</span>)strlen(ms_common)-1; i &gt; 0; i--)
    {
        <span class="keywordflow">if</span>(ms_common[i] == <span class="charliteral">'.'</span>)
        {
            ms_common[i] = <span class="charliteral">'\0'</span>;
            <span class="keywordflow">break</span>;
        }
        <span class="keywordflow">if</span>(ms_common[i] == <span class="charliteral">'\\'</span>)
            <span class="keywordflow">break</span>;
    }
    <span class="comment">// Generate stream names and open output files</span>
    <span class="keywordflow">for</span>(i = 0; i &lt; num_ms_streams; i++)
    {
        <span class="keywordtype">int</span> width;
        <span class="keywordtype">int</span> height;
        <span class="keywordtype">int</span> bitrate;
        <span class="keywordtype">int</span> qp;
        <span class="keywordtype">char</span> ms_name[MAX_FILE_NAME];
        <span class="keywordtype">char</span> suffix[MAX_FILE_NAME];

        <span class="keywordflow">if</span>(i == 0)
        {   <span class="comment">// from base layer settings</span>
            width   = s-&gt;<a class="code" href="structv4e__settings__t.html#4e97b24b422ee624a81c698c25c9dcd3" title="encoding frame width, pixels; [will be automatically calculated by &amp;quot;check_settings()&amp;quot;]...">frame_width</a>;
            height  = s-&gt;<a class="code" href="structv4e__settings__t.html#c64066f22394a290707a0b326779ee57" title="encoding frame height, pixels; [will be automatically calculated by &amp;quot;check_settings()&amp;quot;]...">frame_height</a>;
            bitrate = s-&gt;<a class="code" href="structv4e__settings__t.html#673f06b50e9489afa73087ee5baeb146" title="Rate Control settings;.">rc</a>.<a class="code" href="structrate__control__settings__t.html#667f38da2f2c7f41c9584b1534d1d3d1" title="desired bitrate (kbits per sec);">kbps</a>;
            qp      = s-&gt;<a class="code" href="structv4e__settings__t.html#673f06b50e9489afa73087ee5baeb146" title="Rate Control settings;.">rc</a>.<a class="code" href="structrate__control__settings__t.html#e017f816dcf1784e2126ebf92b847c2f" title="init param for intra frames (0..51);">qp_intra</a>;
        }
        <span class="keywordflow">else</span>
        {   <span class="comment">// from svc layers settings</span>
            width   = s-&gt;<a class="code" href="structv4e__settings__t.html#0eb9ab59c4fc040a3d4710b5ccfe617d" title="svc encoding settings">svc</a>.<a class="code" href="structsvc__settings__t.html#fc8f65b519af39d1a8548884b49ed5a3" title="Last valid element of this array is related to the to the most “rich” layer.">layer</a>[i-1].<a class="code" href="structsvc__layer__settings__t.html#7783c8bf3d8098aa2700d551890281ac" title="encoding frame width, pixels;">frame_width</a>;
            height  = s-&gt;<a class="code" href="structv4e__settings__t.html#0eb9ab59c4fc040a3d4710b5ccfe617d" title="svc encoding settings">svc</a>.<a class="code" href="structsvc__settings__t.html#fc8f65b519af39d1a8548884b49ed5a3" title="Last valid element of this array is related to the to the most “rich” layer.">layer</a>[i-1].<a class="code" href="structsvc__layer__settings__t.html#c67c8334afbf131d5cb5471814903bc5" title="encoding frame height, pixels;">frame_height</a>;
            bitrate = s-&gt;<a class="code" href="structv4e__settings__t.html#0eb9ab59c4fc040a3d4710b5ccfe617d" title="svc encoding settings">svc</a>.<a class="code" href="structsvc__settings__t.html#fc8f65b519af39d1a8548884b49ed5a3" title="Last valid element of this array is related to the to the most “rich” layer.">layer</a>[i-1].<a class="code" href="structsvc__layer__settings__t.html#a730738dd24fa4d7a0267c1620519166" title="desired bitrate (for this plus below levels) Must be greater then kbps for previous...">kbps</a>;
            qp      = s-&gt;<a class="code" href="structv4e__settings__t.html#0eb9ab59c4fc040a3d4710b5ccfe617d" title="svc encoding settings">svc</a>.<a class="code" href="structsvc__settings__t.html#fc8f65b519af39d1a8548884b49ed5a3" title="Last valid element of this array is related to the to the most “rich” layer.">layer</a>[i-1].<a class="code" href="structsvc__layer__settings__t.html#27bd2061ea4766a0e4f6d6128d93051a" title="qp for intra-frames coding (qp_delta_p and qp_delta_b is used from main settings)(used...">qp_intra</a>;
        }

        <span class="keywordflow">if</span>(s-&gt;<a class="code" href="structv4e__settings__t.html#0eb9ab59c4fc040a3d4710b5ccfe617d" title="svc encoding settings">svc</a>.<a class="code" href="structsvc__settings__t.html#408e8588246f8a76c37050f56695297b">multistream_mode</a> == <a class="code" href="v4e__settings_8h.html#73683698f52b7fac59e9fa6cb29699a707978eefce87eb9a860050a53491ff58" title="MVC - generate MVC stream.">MULTISTREAM_MODE_MVC</a>)
        {
            sprintf(suffix, <span class="stringliteral">"%d.264"</span>, i);
        }
        <span class="keywordflow">else</span>
        {
            <span class="keywordflow">if</span>(s-&gt;<a class="code" href="structv4e__settings__t.html#673f06b50e9489afa73087ee5baeb146" title="Rate Control settings;.">rc</a>.<a class="code" href="structrate__control__settings__t.html#6035018e99cb75d477cd5d75291d69d8" title="rate control mode;">type</a> != <a class="code" href="v4e__settings_8h.html#ba66a1cb381789f7785de43b8b66c3bc00321cae4ed1af0817cb6710e7eb3251" title="fixed quality (fixed QP);">RATE_CONTROL_QP</a>)
            {
                sprintf(suffix, <span class="stringliteral">"%d_%dx%d_%dkbps.264"</span>, i+1, width, height, bitrate);
            }
            <span class="keywordflow">else</span>
            {
                sprintf(suffix, <span class="stringliteral">"%d_%dx%d_qp%d.264"</span>, i+1, width, height, qp);
            }
        }
        strcpy(ms_name, ms_common);
        strncat(ms_name, suffix, <span class="keyword">sizeof</span>(suffix));
        file_ms[i] = fopen(ms_name, <span class="stringliteral">"wb"</span>);
        <span class="keywordflow">if</span>(file_ms[i] == NULL)
        {
            verbose_print(0, <span class="stringliteral">"Warning: can't open multi-stream file [%s]\n"</span>, ms_name);
        }
    }
    
    <span class="keywordflow">return</span> 0;
}

<span class="keyword">static</span> <span class="keywordtype">void</span> multistream_write(<a class="code" href="structmedia__sample__t.html">media_sample_t</a> *ms)
{
    <span class="keyword">static</span> byte start_code[4] = {0,0,0,1};
    uint8_t n = ((<a class="code" href="structframe__info__t.html" title="Generic frame information.">frame_info_t</a> *)ms-&gt;<a class="code" href="structmedia__sample__t.html#5bc638fb7b2c7d04af4212143dc77d97" title="can be used for support information">extra_data</a>)-&gt;num_stream;
    FILE *<a class="code" href="v4file_8h.html#d6c10011958844f0803c040a760d2fb9">file_out</a>;

    <span class="keywordflow">if</span>(num_ms_streams &lt; 2)
    {
        <span class="keywordflow">return</span>;
    }

    <span class="keywordflow">if</span>(n &gt;= (uint8_t)num_ms_streams)
    {
        <span class="keywordflow">return</span>;
    }

    file_out = file_ms[n];
    
    <span class="keywordflow">if</span>(file_out != NULL)
    {
        <span class="comment">// Annex B format: 4 bytes start code and NAL unit RBSP contents</span>
        fwrite(start_code, 1, 4, file_out);
        fwrite(ms-&gt;<a class="code" href="structmedia__sample__t.html#fc893318b1f2b8f9412090e104d33f9e" title="data buffer">data</a>, 1, ms-&gt;<a class="code" href="structmedia__sample__t.html#aeaf60c3f4396ad4b4d24f1ffe62eca5" title="total used size, bytes">used_size</a>, file_out);
    }
}

<span class="keyword">static</span> <span class="keywordtype">void</span> multistream_close(<span class="keywordtype">void</span>)
{
    <span class="keywordtype">int</span> i;

    <span class="keywordflow">for</span>(i = 0; i &lt; num_ms_streams; i++)
    {
        <span class="keywordflow">if</span>(file_ms[i] != NULL)
        {
            fclose(file_ms[i]);
        }
    }
}

<span class="keyword">static</span> <span class="keywordtype">int</span> dump_nondef_params(<span class="keywordtype">void</span> *ctx, <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> *fmt, <span class="keywordtype">int</span> value, <span class="keywordtype">int</span> def)
{
    <span class="keywordtype">char</span> sformat[256];
    <span class="keywordflow">if</span> (value != def)
    {
        sprintf(sformat, <span class="stringliteral">"%%s = %s\n"</span>, fmt);
        verbose_print(1, sformat, name, value);
    }
    <span class="keywordflow">return</span> 0;
}

<span class="keyword">static</span> <span class="keywordtype">int</span> dump_all_params(<span class="keywordtype">void</span> *ctx, <span class="keywordtype">char</span> *name, <span class="keywordtype">char</span> *fmt, <span class="keywordtype">int</span> value, <span class="keywordtype">int</span> def)
{
    <span class="keywordtype">char</span> sformat[256];
    sprintf(sformat, <span class="stringliteral">"%%s = %s\n"</span>, fmt);
    verbose_print(1, sformat, name, value);
    <span class="keywordflow">return</span> 0;
}

<span class="keyword">static</span> <span class="keywordtype">void</span> dump_encoder_settings(<a class="code" href="structv4e__settings__t.html" title="All encoder settings.">v4e_settings_t</a> *settings, <span class="keywordtype">int</span> <a class="code" href="v4file_8h.html#0b2caeb4b6f130be43e5a2f0267dd453">verbose</a>)
{
    <span class="comment">// use callback function to dump encoder settings to standard output</span>
    <span class="keywordflow">switch</span> (verbose)
    {
    <span class="keywordflow">case</span> 1:
        <a class="code" href="group__enc__func.html#gcf1c698170ae036dc0b9e7805212e64e" title="Dump given encoder settings via callback function.">v4e_settings2buf_ex</a>(settings, NULL, dump_nondef_params);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 2:
        <a class="code" href="group__enc__func.html#gcf1c698170ae036dc0b9e7805212e64e" title="Dump given encoder settings via callback function.">v4e_settings2buf_ex</a>(settings, NULL, dump_all_params);
        <span class="keywordflow">break</span>;
    <span class="keywordflow">default</span>:
        <span class="keywordflow">return</span>;
    }
    verbose_print(1, <span class="stringliteral">"\n"</span>);
}

<span class="keyword">static</span> <span class="keywordtype">int</span> release_raw_frame(<span class="keywordtype">void</span> *ctx, <span class="keywordtype">void</span> *frame)
{
    raw_frame_ex_t *fr_ex = (raw_frame_ex_t *)frame;
    assert(fr_ex-&gt;busy == 1);
    fr_ex-&gt;busy = 0;
    <span class="keywordflow">return</span> 0;
}

<span class="keyword">static</span> <span class="keywordtype">long</span> frame_read_data(<span class="keywordtype">void</span> *ctx, <span class="keywordtype">void</span> *data, <span class="keywordtype">long</span> size)
{
    <span class="keywordtype">long</span> bytes = 0;
    FILE *f = (FILE*)ctx;
    <span class="keywordflow">if</span> (f)
    {
        bytes = (long)fread(data, 1, size, f);
    }
    <span class="keywordflow">return</span> bytes;
}

<span class="keyword">static</span> <span class="keywordtype">long</span> frame_write_data(<span class="keywordtype">void</span> *ctx, <span class="keywordtype">void</span> *data, <span class="keywordtype">long</span> size)
{
    <span class="keywordtype">long</span> bytes = 0;
    FILE *f = (FILE*)ctx;
    <span class="keywordflow">if</span> (f)
    {
        bytes = (long)fwrite(data, 1, size, f);
    }
    <span class="keywordflow">return</span> bytes;
}

<span class="keyword">static</span> <span class="keywordtype">void</span> init_raw_frames(<a class="code" href="structv4e__settings__t.html" title="All encoder settings.">v4e_settings_t</a> *settings)
{
    <span class="keywordtype">int</span> i,j;
    <span class="keywordtype">int</span> num_views = num_dep_views + 1;
    <a class="code" href="v4__types_8h.html#16b49001d76a0fe1b71b295aa706f6d6" title="known colorspace formats">colorspace_e</a> colorspace = settings-&gt;<a class="code" href="structv4e__settings__t.html#d5e9ef1ce39f150fadd44e7cfa95e14f" title="input picture description;">input</a>.<a class="code" href="structinput__picture__t.html#15054ffcf190e18a6179b7ae193a759f" title="colorspace specification;">colorspace</a>;
    <span class="keywordtype">int</span> width  = settings-&gt;<a class="code" href="structv4e__settings__t.html#d5e9ef1ce39f150fadd44e7cfa95e14f" title="input picture description;">input</a>.<a class="code" href="structinput__picture__t.html#350e9e105180c1c48f533bd331558189" title="picture width, pixels">width</a>;
    <span class="keywordtype">int</span> height = settings-&gt;<a class="code" href="structv4e__settings__t.html#d5e9ef1ce39f150fadd44e7cfa95e14f" title="input picture description;">input</a>.<a class="code" href="structinput__picture__t.html#48eeb84242667de595027a4ab51725a1" title="picture height, pixels">height</a>;
    <span class="keywordtype">int</span> bytes_per_pel = settings-&gt;<a class="code" href="structv4e__settings__t.html#d5e9ef1ce39f150fadd44e7cfa95e14f" title="input picture description;">input</a>.<a class="code" href="structinput__picture__t.html#9faa158cf534bfadaf2526bfa5b9c934" title="size of one pixel sample, bytes (default 1);">sample_size</a>;

    <span class="keywordflow">if</span> (use_async_feed)
    {
        num_raw_frames = <a class="code" href="v4e__api_8h.html#12651221ee1bba21d9c76a002065b45b" title="for backward compatibility">NUM_RGB_FRAMES</a>;
    }

    <span class="comment">// create frame factory per every view</span>
    <span class="keywordflow">for</span> (j = 0; j &lt; num_views; j++)
    {
        FILE *f = (j == 0)? <a class="code" href="v4file_8h.html#15c1ffab0926c9d750ff119cca0285b0">file_in</a> : files_mvc[j-1];
        <a class="code" href="vp_8h.html#521e824f358b31d13cae1dd5306cabcb" title="initialize frame factory instance with extra bit depth;">vp_init_frame_factory_ex</a>(&amp;vpfactory[j],
            width, height, bytes_per_pel, colorspace, f, 
            frame_read_data, frame_write_data);
    }

    <span class="comment">// allocate raw frames</span>
    <span class="keywordflow">for</span> (i = 0; i &lt; num_raw_frames; i++)
    {
        <span class="keywordflow">for</span> (j = 0; j &lt; num_views; j++)
        {
            <a class="code" href="structvp__raw__frame__t.html" title="structure holding external image and it&amp;#39;s characteristics">vp_raw_frame_t</a> *vp_rawframe = &amp;raw_frames[i].vp_views[j];
            memset(vp_rawframe, 0, <span class="keyword">sizeof</span>(<a class="code" href="structvp__raw__frame__t.html" title="structure holding external image and it&amp;#39;s characteristics">vp_raw_frame_t</a>));
            vpfactory[j].<a class="code" href="structvp__frame__factory__t.html#c86568ec03934be8e582ceb988f63f98" title="alloc one more vp_frame_t">alloc_frame</a>(&amp;vpfactory[j], &amp;vp_rawframe-&gt;<a class="code" href="structvp__raw__frame__t.html#6339617e112e0939b8ad06e361e942cd">vp_frame</a>);
        }
        raw_frames[i].busy = 0;
        raw_frames[i].num_views = num_views;
    }
}

<span class="keyword">static</span> <span class="keywordtype">void</span> free_raw_frames(<span class="keywordtype">void</span>)
{
    <span class="keywordtype">int</span> num_views = num_dep_views + 1;
    <span class="keywordtype">int</span> i,j;
    <span class="keywordflow">for</span> (i = 0; i &lt; num_raw_frames; i++)
    {
        <span class="keywordflow">for</span> (j = 0; j &lt; raw_frames[i].num_views; j++)
        {
            <a class="code" href="structvp__frame__t.html" title="frame specification">vp_frame_t</a> *vpframe  = &amp;raw_frames[i].vp_views[j].vp_frame;
            vpfactory[j].<a class="code" href="structvp__frame__factory__t.html#16c31808753a6c361f19e2bfed733886" title="free vp_frame_t">free_frame</a>(&amp;vpfactory[j], vpframe);
        }
    }
    <span class="keywordflow">for</span> (j = 0; j &lt; num_views; j++)
    {
        vpfactory[j].<a class="code" href="structvp__frame__factory__t.html#0a453d87ad37556b7dbe926ad3665fb0" title="free allocated resources, raw frames should be already freed">close</a>(&amp;vpfactory[j]);
    }
}

<span class="keyword">static</span> raw_frame_ex_t *get_raw_frame(<span class="keywordtype">int</span> frame_num)
{
    <span class="keywordtype">int</span> i;
    <span class="keywordtype">int</span> index = (use_async_feed)? (frame_num % <a class="code" href="v4e__api_8h.html#12651221ee1bba21d9c76a002065b45b" title="for backward compatibility">NUM_RGB_FRAMES</a>) : 0;
    raw_frame_ex_t *raw_frame = &amp;raw_frames[index]; <span class="comment">// use frames array as ring buffer</span>
    raw_frame-&gt;busy = 1;
    <span class="keywordflow">for</span> (i = 0; i &lt; raw_frame-&gt;num_views; i++)
    {
        raw_frame-&gt;vp_views[i].sei_list = NULL;
    }
    <span class="keywordflow">return</span> raw_frame;
}

<span class="keyword">static</span> <span class="keywordtype">int</span> add_CC_PD_vp(<a class="code" href="structvp__raw__frame__t.html" title="structure holding external image and it&amp;#39;s characteristics">vp_raw_frame_t</a> *raw_frame);

<span class="keyword">static</span> <span class="keywordtype">void</span> feed_raw_frame(<span class="keywordtype">void</span> *handle, raw_frame_ex_t *raw_frame, <span class="keywordtype">int</span> frame_num)
{
    <span class="keywordtype">int</span> i;
    <a class="code" href="structframe__modifier__t.html" title="This structure could be used by encoding application to modify default slice encoding...">frame_modifier_t</a> frame_modifier;

    <span class="comment">// add CC &amp; PD custom SEI messages; only for first view now</span>
    add_CC_PD_vp(&amp;raw_frame-&gt;vp_views[0]); 

    <span class="comment">// customize a frame by using frame modifier</span>
    <span class="keywordflow">if</span> (use_frame_modifier)
    {
        frame_modifier.<a class="code" href="structframe__modifier__t.html#da42e38db5920084ffa766f5fc61cb2a" title="keyframe flag: 0 means no key frame, 1 means key frame">idr_flag</a> = (int8_t)((frame_num % use_frame_modifier) == 0);
        frame_modifier.<a class="code" href="structframe__modifier__t.html#6739e0c6b42001562bbdf1cd51fcfced" title="Q(uant) P(arameter) for this frame.">qp</a> = -1;
        frame_modifier.<a class="code" href="structframe__modifier__t.html#183debf40645f3fad8621b6ba6ea14c6" title="type of the slice to use (see slice_type_e)">slice_type</a> = -1;
        <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="v4__types_8h.html#d2b263145a11ddb6e5d02fbb1fb865fd" title="Maximum number of SVC layers in encoder.">MAX_SVC_LAYERS</a>; i++)
        {
            frame_modifier.<a class="code" href="structframe__modifier__t.html#3ec2de203b6df0dc6b9c00d646581497">svc_layers_qp</a>[i] = -1;
        }
        raw_frame-&gt;vp_views[0].modifier = &amp;frame_modifier;
    }

    <a class="code" href="group__enc__func.html#gff6489f204c9bf8172340dc69793eb37" title="The function sends given frame to encoder and immediately returns.">v4e_set_vp_frame</a>(handle, raw_frame-&gt;vp_views, 1);
}

<span class="keyword">static</span> <span class="keywordtype">void</span> copy_frame(<a class="code" href="structvp__frame__t.html" title="frame specification">vp_frame_t</a> *dstframe, <a class="code" href="structvp__frame__t.html" title="frame specification">vp_frame_t</a> *srcframe)
{
    <a class="code" href="vp_8h.html#4932bdad8a35c0e14a4f045302137755" title="batch is a frame operation unit">vp_batch_t</a> batch;
    <span class="keywordtype">int</span> is_interlace = 0;   <span class="comment">// ???</span>
    <span class="keywordtype">int</span> rc;
    rc = <a class="code" href="vp_8h.html#43b5f9b5b31384915f8127a7b68ef338" title="create batch instance;">vp_open</a>(&amp;batch, srcframe, is_interlace);
    srcframe-&gt;<a class="code" href="structvp__frame__t.html#9cd1a9684d78c0021dfbc22819af045d" title="number of rows to be processed together">valid_rows_count</a> = srcframe-&gt;<a class="code" href="structvp__frame__t.html#e69ce64c7744aad8b70ff15302a44c7e" title="image height, pixels;">height</a>;
    rc = <a class="code" href="vp_8h.html#9fd8a2b7c1b32c2fa02345e994413809" title="process a next part of the batch as signalled by &amp;quot;src.valid_rows_count&amp;quot;...">vp_process</a>(batch, srcframe, dstframe);
    <a class="code" href="vp_8h.html#448850dcb379cb0c7e46c200512715f0" title="close (free) batch instance;">vp_close</a>(batch);
}

<span class="keyword">static</span> <span class="keywordtype">int</span> readNextRawFrame(<span class="keywordtype">int</span> allow_preload, <span class="keywordtype">int</span> framenum, raw_frame_ex_t *rawframe)
{
    <span class="keywordtype">int</span> i;
    <span class="keywordtype">int</span> rc = 0;
    <a class="code" href="structvp__frame__t.html" title="frame specification">vp_frame_t</a> *srcframe;
    <a class="code" href="structvp__frame__t.html" title="frame specification">vp_frame_t</a> *dstframe;

    <span class="keywordflow">if</span> (allow_preload &amp;&amp; (preload_frames &gt; 0))
    {
        <span class="keywordtype">int</span> preload_framenum = framenum % preload_frames;
        <span class="keywordflow">for</span> (i = 0; i &lt; rawframe-&gt;num_views; i++)
        {
            srcframe = &amp;preload_buffer[i][preload_framenum];
            dstframe = &amp;(rawframe-&gt;vp_views[i].vp_frame);
            copy_frame(dstframe, srcframe);
        }
    }
    <span class="keywordflow">else</span>
    {
        <span class="keywordflow">for</span> (i = 0; i &lt; rawframe-&gt;num_views; i++)
        {
            dstframe = &amp;(rawframe-&gt;vp_views[i].vp_frame);
            <span class="keywordflow">if</span>(rgb_switch)
            {
                dstframe-&gt;<a class="code" href="structvp__frame__t.html#e69ce64c7744aad8b70ff15302a44c7e" title="image height, pixels;">height</a> = -abs(dstframe-&gt;<a class="code" href="structvp__frame__t.html#e69ce64c7744aad8b70ff15302a44c7e" title="image height, pixels;">height</a>);
            }
            rc = (int)vpfactory[i].read_frame(&amp;vpfactory[i], dstframe);
        }
    }
    <span class="keywordflow">return</span> rc;
}

<span class="keyword">static</span> <span class="keywordtype">void</span> rewindInput(<span class="keywordtype">void</span>)
{
    <span class="keywordtype">int</span> i;
    rewind_input_file();
    <span class="keywordflow">for</span> (i = 0; i &lt; num_dep_views; i++)
    {
        fseek(files_mvc[i], 0, SEEK_SET);
    }
}

<span class="keyword">static</span> <span class="keywordtype">int</span> preloadView(<span class="keywordtype">int</span> viewnum)
{
    <span class="keywordtype">int</span> numframes;
    <span class="keywordtype">int</span> i, bufsize, rc;
    <a class="code" href="structvp__frame__t.html" title="frame specification">vp_frame_t</a> *vpframe;

    numframes = use_preload;
    <span class="keywordflow">if</span> (numframes == -1)
    {
        numframes = max_frames;
    }
    <span class="keywordflow">if</span> (numframes &lt;= 0)
    {
        <span class="keywordflow">return</span> -1;
    }
    <span class="comment">// alloc buffer</span>
    bufsize = numframes * <span class="keyword">sizeof</span>(<a class="code" href="structvp__frame__t.html" title="frame specification">vp_frame_t</a>);
    preload_buffer[viewnum] = (<a class="code" href="structvp__frame__t.html" title="frame specification">vp_frame_t</a> *)<a class="code" href="v4__types_8h.html#171a393160825111f855cd9020c5a17d" title="recommended allocation method for media frames">v4_malloc</a>(bufsize);
    <span class="keywordflow">if</span> (!preload_buffer[viewnum])
    {
        verbose_print(0, <span class="stringliteral">"*** preload[%d]: insufficient memory (%d bytes)\n"</span>, viewnum, bufsize);
        <span class="keywordflow">return</span> -1;
    }

    <span class="comment">// alloc &amp; read frames</span>
    verbose_print(1, <span class="stringliteral">"*** preload[%d]: %d frames ... "</span>, viewnum, numframes);
    preload_frames = 0;
    <span class="keywordflow">for</span> (i=0; i&lt;numframes; i++)
    {
        vpframe = &amp;preload_buffer[viewnum][i];
        rc = vpfactory[viewnum].<a class="code" href="structvp__frame__factory__t.html#c86568ec03934be8e582ceb988f63f98" title="alloc one more vp_frame_t">alloc_frame</a>(&amp;vpfactory[viewnum], vpframe);
        <span class="keywordflow">if</span> (rc != 0)
        {
            verbose_print(0, <span class="stringliteral">"*** preload[%d]: insufficient memory for frame #%d\n"</span>, viewnum, i);
            <span class="keywordflow">return</span> -1;
        }
        rc = (int)vpfactory[viewnum].read_frame(&amp;vpfactory[viewnum], vpframe);
        <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">break</span>;
        preload_frames += 1;
    }
    verbose_print(1, <span class="stringliteral">"%d frames read\n"</span>, preload_frames);
    <span class="keywordflow">return</span> 0;
}

<span class="keyword">static</span> <span class="keywordtype">void</span> preloadInit(<span class="keywordtype">void</span>)
{
    <span class="keywordtype">int</span> viewnum;
    <span class="keywordtype">int</span> num_views = num_dep_views + 1;
    <span class="keywordflow">for</span> (viewnum = 0; viewnum &lt; num_views; viewnum++)
    {
        preloadView(viewnum);
    }
}

<span class="keyword">static</span> <span class="keywordtype">void</span> preloadClose(<span class="keywordtype">void</span>)
{
    <span class="keywordtype">int</span> rc, i, viewnum;
    <a class="code" href="structvp__frame__t.html" title="frame specification">vp_frame_t</a> *vpframe;
    <span class="keywordtype">int</span> num_views = num_dep_views + 1;

    <span class="keywordflow">for</span> (viewnum = 0; viewnum &lt; num_views; viewnum++)
    {
        <span class="keywordflow">if</span> (preload_buffer[viewnum] != NULL)
        {
            <span class="keywordflow">for</span> (i=0; i&lt;preload_frames; i++)
            {
                vpframe = &amp;preload_buffer[viewnum][i];
                rc = (int)vpfactory[viewnum].free_frame(&amp;vpfactory[viewnum], vpframe);
            }
            <a class="code" href="v4__types_8h.html#0193bc6dbb7dc19180f0253558de4b5e" title="recommended free method for memory blocks created by v4_malloc()">v4_free</a>(preload_buffer[viewnum]);
        }
    }
}


<span class="keyword">static</span> <span class="keywordtype">int</span> add_CC_PD_to_sei_list(<a class="code" href="structmedia__sample__t.html">media_sample_t</a> **sei_list)
{
    <span class="keywordtype">char</span> *buf;
    <span class="keywordtype">char</span> *sei_data;
    <span class="keywordtype">int</span> rc, sei_size, sei_flags, i, len;

    sei_flags = <a class="code" href="v4__types_8h.html#4c5d0f99fc392f1f25bc3cc815554d68dd260a3531b2f8e1d4bfaad9e6db6dd0" title="this sei must be coded in separate nal-unit">SEI_FLAG_SEPARATE_NAL</a>;
    buf = (<span class="keywordtype">char</span>*)malloc(<a class="code" href="v4__types_8h.html#1b6900b3d55806724992ec3229faeb98" title="maximum allowed length of one Private Data message">MAX_PD_LEN</a>);
    <span class="keywordflow">if</span> (!buf) <span class="keywordflow">return</span> -1;

    <span class="comment">// read CC (closed caption)</span>
    sei_data = readCC(buf, <a class="code" href="v4__types_8h.html#1b6900b3d55806724992ec3229faeb98" title="maximum allowed length of one Private Data message">MAX_PD_LEN</a>);
    <span class="keywordflow">if</span> (sei_data)
    {
        <a class="code" href="structitu__t__t35__t.html">itu_t_t35_t</a> itu_t_t35;
        <a class="code" href="structatsc1__data__t.html">atsc1_data_t</a> *atsc1;
        <a class="code" href="structcc__data__t.html">cc_data_t</a> *cc;
        memset(&amp;itu_t_t35, 0, <span class="keyword">sizeof</span>(<a class="code" href="structitu__t__t35__t.html">itu_t_t35_t</a>));
        itu_t_t35.<a class="code" href="structitu__t__t35__t.html#b74596c17b7ffd87a29648a2c3cebf6e">user_identifier</a> = <a class="code" href="v4__types_8h.html#cd5dcb76a598098665c35e81ec938370">ITU_T_T35_UID_ATSC1</a>;
        atsc1 = &amp;itu_t_t35.<a class="code" href="structitu__t__t35__t.html#56acd84f80eddf47b448d374fc5dabac">user_structure</a>.<a class="code" href="structitu__t__t35__t.html#cba92460ba5bb1c5a69b1885d1d47551">atsc1_data</a>;
        atsc1-&gt;<a class="code" href="structatsc1__data__t.html#1a0722e412e1962e759134f6be012754">user_data_type_code</a> = <a class="code" href="v4__types_8h.html#eac8d78cb396eaac9a3b53f80ca1ef5d">ATSC1_TYPE_CC</a>;
        cc = &amp;atsc1-&gt;<a class="code" href="structatsc1__data__t.html#dcd257ce32bf84fd1586fbe7b3cc0087">user_data_type_structure</a>.<a class="code" href="structatsc1__data__t.html#6ccd95f42e6565d656469f719a39e910">cc_data</a>;
        len = (int)strlen(sei_data);
        cc-&gt;<a class="code" href="structcc__data__t.html#23cf963022c35bc6037e78920c3efebf">cc_count</a> = len / 2;
        <span class="keywordflow">if</span> (cc-&gt;<a class="code" href="structcc__data__t.html#23cf963022c35bc6037e78920c3efebf">cc_count</a> &gt; <a class="code" href="v4__types_8h.html#304278271575f282fcd5eec501ab5603" title="maximum number of CC items per frame: 5 bits = [0..31]">MAX_CC_ITEMS</a>) cc-&gt;<a class="code" href="structcc__data__t.html#23cf963022c35bc6037e78920c3efebf">cc_count</a> = <a class="code" href="v4__types_8h.html#304278271575f282fcd5eec501ab5603" title="maximum number of CC items per frame: 5 bits = [0..31]">MAX_CC_ITEMS</a>;
        <span class="keywordflow">for</span> (i=0; i&lt;cc-&gt;<a class="code" href="structcc__data__t.html#23cf963022c35bc6037e78920c3efebf">cc_count</a>; i++)
        {
            cc-&gt;<a class="code" href="structcc__data__t.html#6de6c79bc35b69a0764cb73566574560">cc_items</a>[i].<a class="code" href="structcc__item__t.html#8b3108cb20481c1c8a927074de877457">cc_valid</a>  = 1;
            cc-&gt;<a class="code" href="structcc__data__t.html#6de6c79bc35b69a0764cb73566574560">cc_items</a>[i].<a class="code" href="structcc__item__t.html#bdc3173222288a80694d6f52d770e2f6">cc_type</a>   = 0;
            cc-&gt;<a class="code" href="structcc__data__t.html#6de6c79bc35b69a0764cb73566574560">cc_items</a>[i].<a class="code" href="structcc__item__t.html#57cc0aaba4f335f3e286a17209635ad2">cc_data_1</a> = (byte)sei_data[i*2+0];
            cc-&gt;<a class="code" href="structcc__data__t.html#6de6c79bc35b69a0764cb73566574560">cc_items</a>[i].<a class="code" href="structcc__item__t.html#c38d8c3e5e043becb9b7258a81c7d135">cc_data_2</a> = (byte)sei_data[i*2+1];
        }
        sei_size = <span class="keyword">sizeof</span>(<a class="code" href="structitu__t__t35__t.html">itu_t_t35_t</a>);
        rc = <a class="code" href="group__enc__func.html#gf75c1fca53e68950973334067cf3b649" title="Attach custom SEI data to sei list of the input frame before calling to &amp;quot;v4e_set_vp_frame()&amp;quo...">v4e_attach_sei_to_list</a>(sei_list, <a class="code" href="v4__types_8h.html#83d32be44812bee90a164e929472fe83b5a7356d1d2446f2aa0e3ac3d88e3860">SEI_USER_DATA_REGISTERED_ITU_T_T35</a>, &amp;itu_t_t35, sei_size, sei_flags, 0);
        <span class="keywordflow">if</span> (rc != <a class="code" href="group__return__codes.html#gb9dfadfbdfd9326b6a3b31988cd73957" title="Everything is OK.">VSSH_OK</a>)
            verbose_print(0, <span class="stringliteral">"Error: v4e_attach_sei() failed (%d)\n"</span>, rc);

        <span class="comment">// bar_data example</span>
        {
            <a class="code" href="structbar__data__t.html">bar_data_t</a> *bar = &amp;atsc1-&gt;<a class="code" href="structatsc1__data__t.html#dcd257ce32bf84fd1586fbe7b3cc0087">user_data_type_structure</a>.<a class="code" href="structatsc1__data__t.html#b8ecf2093689b1adb652afcb132cd809">bar_data</a>;
            atsc1-&gt;<a class="code" href="structatsc1__data__t.html#1a0722e412e1962e759134f6be012754">user_data_type_code</a> = <a class="code" href="v4__types_8h.html#e38508c3e95358609399fe685b6814b8">ATSC1_TYPE_BAR</a>;
            bar-&gt;<a class="code" href="structbar__data__t.html#f3314d09964e9e4c93cdb9cfb67d45c8">top_bar_flag</a> = 1;
            bar-&gt;<a class="code" href="structbar__data__t.html#7c7c43b7d8efb8afcffaeb6fbe4a92a6">line_number_end_of_top_bar</a> = 13;
            rc = <a class="code" href="group__enc__func.html#gf75c1fca53e68950973334067cf3b649" title="Attach custom SEI data to sei list of the input frame before calling to &amp;quot;v4e_set_vp_frame()&amp;quo...">v4e_attach_sei_to_list</a>(sei_list, <a class="code" href="v4__types_8h.html#83d32be44812bee90a164e929472fe83b5a7356d1d2446f2aa0e3ac3d88e3860">SEI_USER_DATA_REGISTERED_ITU_T_T35</a>, &amp;itu_t_t35, sei_size, sei_flags, 0);
            <span class="keywordflow">if</span> (rc != <a class="code" href="group__return__codes.html#gb9dfadfbdfd9326b6a3b31988cd73957" title="Everything is OK.">VSSH_OK</a>)
                verbose_print(0, <span class="stringliteral">"Error: v4e_attach_sei() failed (%d)\n"</span>, rc);
        }
        <span class="comment">// AFD example</span>
        {
            <a class="code" href="structafd__data__t.html">afd_data_t</a> *afd = &amp;itu_t_t35.<a class="code" href="structitu__t__t35__t.html#56acd84f80eddf47b448d374fc5dabac">user_structure</a>.<a class="code" href="structitu__t__t35__t.html#7cc1c2612b35cad7f10a37bcc7067085">afd_data</a>;
            itu_t_t35.<a class="code" href="structitu__t__t35__t.html#b74596c17b7ffd87a29648a2c3cebf6e">user_identifier</a> = <a class="code" href="v4__types_8h.html#b77a23f9fab1f2f392db3626f2f37a0a">ITU_T_T35_UID_AFD</a>;
            afd-&gt;<a class="code" href="structafd__data__t.html#aaa35feae1b2142d87ae8b1fd9af4627">active_format_flag</a> = 1;
            afd-&gt;<a class="code" href="structafd__data__t.html#ef5b0e66a8107f1384fad96f892374a1">active_format</a> = 13;
            rc = <a class="code" href="group__enc__func.html#gf75c1fca53e68950973334067cf3b649" title="Attach custom SEI data to sei list of the input frame before calling to &amp;quot;v4e_set_vp_frame()&amp;quo...">v4e_attach_sei_to_list</a>(sei_list, <a class="code" href="v4__types_8h.html#83d32be44812bee90a164e929472fe83b5a7356d1d2446f2aa0e3ac3d88e3860">SEI_USER_DATA_REGISTERED_ITU_T_T35</a>, &amp;itu_t_t35, sei_size, sei_flags, 0);
            <span class="keywordflow">if</span> (rc != <a class="code" href="group__return__codes.html#gb9dfadfbdfd9326b6a3b31988cd73957" title="Everything is OK.">VSSH_OK</a>)
                verbose_print(0, <span class="stringliteral">"Error: v4e_attach_sei() failed (%d)\n"</span>, rc);
        }
    }
    <span class="comment">// read PD (private data)</span>
    sei_data = readPD(buf, <a class="code" href="v4__types_8h.html#1b6900b3d55806724992ec3229faeb98" title="maximum allowed length of one Private Data message">MAX_PD_LEN</a>);
    <span class="keywordflow">if</span> (sei_data)
    {
        sei_size = (int)strlen(sei_data);
        rc = <a class="code" href="group__enc__func.html#gf75c1fca53e68950973334067cf3b649" title="Attach custom SEI data to sei list of the input frame before calling to &amp;quot;v4e_set_vp_frame()&amp;quo...">v4e_attach_sei_to_list</a>(sei_list, <a class="code" href="v4__types_8h.html#83d32be44812bee90a164e929472fe83fbbfda0fc7c451c9e2dc047972008fd9">SEI_USER_DATA_UNREGISTERED</a>, sei_data, sei_size, sei_flags, 0);
        <span class="keywordflow">if</span> (rc != <a class="code" href="group__return__codes.html#gb9dfadfbdfd9326b6a3b31988cd73957" title="Everything is OK.">VSSH_OK</a>)
            verbose_print(0, <span class="stringliteral">"Error: v4e_attach_sei() failed (%d)\n"</span>, rc);
    }
    free(buf);
    <span class="keywordflow">return</span> 0;
}


<span class="keyword">static</span> <span class="keywordtype">int</span> add_CC_PD_vp(<a class="code" href="structvp__raw__frame__t.html" title="structure holding external image and it&amp;#39;s characteristics">vp_raw_frame_t</a> *raw_frame)
{
    <span class="keywordflow">return</span> add_CC_PD_to_sei_list(&amp;raw_frame-&gt;<a class="code" href="structvp__raw__frame__t.html#9dbb40595215ccc75914ca7eee0100c3" title="Initially must be set to NULL. Used by v4e_attach_sei() function;.">sei_list</a>);
}

<span class="keyword">static</span> <span class="keywordtype">char</span> *get_nalu_name(<span class="keywordtype">int</span> nalu_type)
{
    <span class="keywordflow">switch</span> (nalu_type)
    {
    <span class="keywordflow">case</span> <a class="code" href="v4__nalu_8h.html#6763687c1f321aeccbcff27ac770bf7e1ed87771b3223fb0723c7d52cd89a8c7">NALU_TYPE_SLICE</a>:   <span class="keywordflow">return</span> <span class="stringliteral">"SLICE"</span>;
    <span class="keywordflow">case</span> <a class="code" href="v4__nalu_8h.html#6763687c1f321aeccbcff27ac770bf7efde8b29c7c7d0a81b077f47c59a0d941">NALU_TYPE_IDR</a>:     <span class="keywordflow">return</span> <span class="stringliteral">"IDR"</span>;
    <span class="keywordflow">case</span> <a class="code" href="v4__nalu_8h.html#6763687c1f321aeccbcff27ac770bf7e662f3f264ce7ebb12e53deacd06fd5aa">NALU_TYPE_SEI</a>:     <span class="keywordflow">return</span> <span class="stringliteral">"SEI"</span>;
    <span class="keywordflow">case</span> <a class="code" href="v4__nalu_8h.html#6763687c1f321aeccbcff27ac770bf7e8e42eccbd67f8ff672126a5faa53f734">NALU_TYPE_SPS</a>:     <span class="keywordflow">return</span> <span class="stringliteral">"SPS"</span>;
    <span class="keywordflow">case</span> <a class="code" href="v4__nalu_8h.html#6763687c1f321aeccbcff27ac770bf7e87c2af4fc4966eb27c3cb8232610e8bc">NALU_TYPE_PPS</a>:     <span class="keywordflow">return</span> <span class="stringliteral">"PPS"</span>;
    <span class="keywordflow">case</span> <a class="code" href="v4__nalu_8h.html#6763687c1f321aeccbcff27ac770bf7e2c51e0a221dd2bd25d8befba179f4b19">NALU_TYPE_PD</a>:      <span class="keywordflow">return</span> <span class="stringliteral">"PD"</span>;
    <span class="keywordflow">case</span> <a class="code" href="v4__nalu_8h.html#6763687c1f321aeccbcff27ac770bf7e8667aa783dca4872642e1c5d9b3af084">NALU_TYPE_FILL</a>:    <span class="keywordflow">return</span> <span class="stringliteral">"FILL"</span>;
    <span class="keywordflow">case</span> <a class="code" href="v4__nalu_8h.html#6763687c1f321aeccbcff27ac770bf7eb7e0d78e144132a4af9cd3c516c3002b">NALU_TYPE_SUBSPS</a>:  <span class="keywordflow">return</span> <span class="stringliteral">"SUBSPS"</span>;
    <span class="keywordflow">case</span> <a class="code" href="v4__nalu_8h.html#6763687c1f321aeccbcff27ac770bf7ed158c06986fb53a651ee281210537fce">NALU_TYPE_SLICE_EXT</a>:  <span class="keywordflow">return</span> <span class="stringliteral">"SLICEEXT"</span>;
    <span class="keywordflow">case</span> <a class="code" href="v4__nalu_8h.html#6763687c1f321aeccbcff27ac770bf7e86afdb923872f66e7fe724b3eff2d16f">NALU_TYPE_PREFIX_EXT</a>: <span class="keywordflow">return</span> <span class="stringliteral">"PREFIX"</span>;
    }
    <span class="keywordflow">return</span> <span class="stringliteral">"UNKNOWN"</span>;
}

<span class="keyword">static</span> <span class="keywordtype">char</span> *get_slice_name(<span class="keywordtype">int</span> slice_type)
{
    <span class="keywordflow">switch</span> (slice_type)
    {
    <span class="keywordflow">case</span> <a class="code" href="v4__types_8h.html#aa8ea00b42634ed067daa4bf77ffbd4e5639bd282d366b358794835b8b9f0ea3">I_SLICE</a>:  <span class="keywordflow">return</span> <span class="stringliteral">"I"</span>;
    <span class="keywordflow">case</span> <a class="code" href="v4__types_8h.html#aa8ea00b42634ed067daa4bf77ffbd4eec6a363b5fde8eac742c686e47eb1ec2">P_SLICE</a>:  <span class="keywordflow">return</span> <span class="stringliteral">"P"</span>;
    <span class="keywordflow">case</span> <a class="code" href="v4__types_8h.html#aa8ea00b42634ed067daa4bf77ffbd4ee5b7697ac1d386edefc799ec1e7438b1">B_SLICE</a>:  <span class="keywordflow">return</span> <span class="stringliteral">"B"</span>;
    <span class="keywordflow">case</span> <a class="code" href="v4__types_8h.html#aa8ea00b42634ed067daa4bf77ffbd4ed6ba2d96293674dbf417a467434d3972">SI_SLICE</a>: <span class="keywordflow">return</span> <span class="stringliteral">"SI"</span>;
    <span class="keywordflow">case</span> <a class="code" href="v4__types_8h.html#aa8ea00b42634ed067daa4bf77ffbd4e448c92d4bd0e24c1870ec770241bde1f">SP_SLICE</a>: <span class="keywordflow">return</span> <span class="stringliteral">"SP"</span>;
    }
    <span class="keywordflow">return</span> <span class="stringliteral">"Unknown"</span>;
}

<span class="keyword">static</span> <span class="keywordtype">void</span> report_media_sample(<span class="keywordtype">int</span> num, <a class="code" href="structmedia__sample__t.html">media_sample_t</a> *ms)
{
    byte first_byte;
    <span class="keywordtype">int</span> nalu_type, nalu_ridc;
    <a class="code" href="structframe__info__t.html" title="Generic frame information.">frame_info_t</a> *info;
    first_byte = ((byte*)(ms-&gt;<a class="code" href="structmedia__sample__t.html#fc893318b1f2b8f9412090e104d33f9e" title="data buffer">data</a>))[0];
    nalu_type = <a class="code" href="v4__nalu_8h.html#331c183fa077f5c00f3530db2615c31a" title="macro to determine NAL unit type by the first byte">NALU_TYPE</a>(first_byte);
    nalu_ridc = <a class="code" href="v4__nalu_8h.html#9c114464a76e21b34a47fef8b2f9a9db" title="macro to determine NAL unit reference IDC by the first byte">NALU_RIDC</a>(first_byte);
    info = (<a class="code" href="structframe__info__t.html" title="Generic frame information.">frame_info_t</a> *)ms-&gt;<a class="code" href="structmedia__sample__t.html#5bc638fb7b2c7d04af4212143dc77d97" title="can be used for support information">extra_data</a>;
    verbose_print(1, <span class="stringliteral">"%6d(%6d): [%d|%2d] %8s"</span>,
        num, ms-&gt;<a class="code" href="structmedia__sample__t.html#aeaf60c3f4396ad4b4d24f1ffe62eca5" title="total used size, bytes">used_size</a>,
        nalu_ridc, nalu_type, get_nalu_name(nalu_type));
    <span class="keywordflow">switch</span> (nalu_type)
    {
    <span class="keywordflow">case</span> <a class="code" href="v4__nalu_8h.html#6763687c1f321aeccbcff27ac770bf7ed158c06986fb53a651ee281210537fce">NALU_TYPE_SLICE_EXT</a>:
        <span class="keywordflow">if</span>(<a class="code" href="v4__nalu_8h.html#004d7031540ecbf5a7297b8a00b2c8d6">NAL_EXT_SVS_EXTENSION_FLAG</a>(ms-&gt;<a class="code" href="structmedia__sample__t.html#fc893318b1f2b8f9412090e104d33f9e" title="data buffer">data</a>))
        {
            verbose_print(1,<span class="stringliteral">" [%d][%d|%d|%d]"</span>,
                <a class="code" href="v4__nalu_8h.html#ea5c23c7ec3dc56972f0c319911be42f">NAL_EXT_PRIORITY_ID</a>(ms-&gt;<a class="code" href="structmedia__sample__t.html#fc893318b1f2b8f9412090e104d33f9e" title="data buffer">data</a>),
                <a class="code" href="v4__nalu_8h.html#a4ef4eb0e60fe84a6ec758caf8e90dfc">NAL_EXT_DEPENDENCY_ID</a>(ms-&gt;<a class="code" href="structmedia__sample__t.html#fc893318b1f2b8f9412090e104d33f9e" title="data buffer">data</a>),
                <a class="code" href="v4__nalu_8h.html#2ad91893a93a089192154e0a6156bc15">NAL_EXT_TEMPORAL_ID</a>(ms-&gt;<a class="code" href="structmedia__sample__t.html#fc893318b1f2b8f9412090e104d33f9e" title="data buffer">data</a>),
                <a class="code" href="v4__nalu_8h.html#0281bb909550ab3b01ee2d4429aea5ed">NAL_EXT_QUALITY_ID</a>(ms-&gt;<a class="code" href="structmedia__sample__t.html#fc893318b1f2b8f9412090e104d33f9e" title="data buffer">data</a>)
                );
            <span class="keywordflow">if</span> (<a class="code" href="v4__nalu_8h.html#17751789569299c6c76822d5ad088690">NAL_EXT_IDR</a>(ms-&gt;<a class="code" href="structmedia__sample__t.html#fc893318b1f2b8f9412090e104d33f9e" title="data buffer">data</a>))
                verbose_print(1,<span class="stringliteral">" IDR"</span>);
        }
        <span class="keywordflow">else</span>
        {
            verbose_print(1,<span class="stringliteral">" MVC[%d][%d|%d]"</span>,
                <a class="code" href="v4__nalu_8h.html#dd737e16c8fa661de7a18523798449fc">NAL_MVC_EXT_PRIORITY_ID</a>(ms-&gt;<a class="code" href="structmedia__sample__t.html#fc893318b1f2b8f9412090e104d33f9e" title="data buffer">data</a>),
                <a class="code" href="v4__nalu_8h.html#efdf14ff7c9337fb35bfaa0d87f293aa">NAL_MVC_EXT_TEMPORAL_ID</a>(ms-&gt;<a class="code" href="structmedia__sample__t.html#fc893318b1f2b8f9412090e104d33f9e" title="data buffer">data</a>),
                <a class="code" href="v4__nalu_8h.html#49152119a8cd6fa6cb387c2c922ac40e">NAL_MVC_EXT_VIEW_ID</a>(ms-&gt;<a class="code" href="structmedia__sample__t.html#fc893318b1f2b8f9412090e104d33f9e" title="data buffer">data</a>)
                );
            <span class="keywordflow">if</span> (!<a class="code" href="v4__nalu_8h.html#520e168dda7df9c929ae005bc2b6441e">NAL_MVC_EXT_NON_IDR</a>(ms-&gt;<a class="code" href="structmedia__sample__t.html#fc893318b1f2b8f9412090e104d33f9e" title="data buffer">data</a>))
                verbose_print(1,<span class="stringliteral">" IDR"</span>);
            <span class="keywordflow">if</span>(<a class="code" href="v4__nalu_8h.html#7356859c6c293a4b1c17e06ab9008782">NAL_MVC_EXT_ANCHOR_PIC</a>(ms-&gt;<a class="code" href="structmedia__sample__t.html#fc893318b1f2b8f9412090e104d33f9e" title="data buffer">data</a>))
                verbose_print(1,<span class="stringliteral">" ANCHOR"</span>);
        }
    <span class="keywordflow">case</span> <a class="code" href="v4__nalu_8h.html#6763687c1f321aeccbcff27ac770bf7efde8b29c7c7d0a81b077f47c59a0d941">NALU_TYPE_IDR</a>:
    <span class="keywordflow">case</span> <a class="code" href="v4__nalu_8h.html#6763687c1f321aeccbcff27ac770bf7e1ed87771b3223fb0723c7d52cd89a8c7">NALU_TYPE_SLICE</a>:
        verbose_print(1, <span class="stringliteral">" %s[%d] qp=%d ts=%d"</span>,
            get_slice_name(info-&gt;<a class="code" href="structframe__info__t.html#da9394965abb7a1a4ad8879e4ec1eddd" title="type of the slice (see slice_type_e)">slice_type</a>),
            info-&gt;<a class="code" href="structframe__info__t.html#4831749e5b957bfd08347c3f7acd2d23" title="logical number of the frame">frame_num</a>,
            info-&gt;<a class="code" href="structframe__info__t.html#cbc281094d9f6489d0da0cd44edb22bc" title="qp used for the frame">qp_used</a>,
            (<span class="keywordtype">int</span>)(ms-&gt;<a class="code" href="structmedia__sample__t.html#9fd3638e794327d6e62d052ca6da4197" title="external timestamp">timestamp</a>/10000)
            );
        <span class="keywordflow">break</span>;
    }
    verbose_print(1, <span class="stringliteral">"\n"</span>);
}

<span class="comment">// this function calculates next frame time stamp using current frame rate value</span>
<span class="comment">// we use 10^7 timer frequency as per DirectX nature</span>
<span class="preprocessor">#define ONE_SEC (10000000)</span>
<span class="preprocessor"></span><span class="keyword">static</span> int64_t calc_timestamp(<a class="code" href="structv4e__settings__t.html" title="All encoder settings.">v4e_settings_t</a> *settings, <span class="keywordtype">int</span> num)
{
    int64_t ts;
    <span class="keywordtype">int</span> num_units = settings-&gt;<a class="code" href="structv4e__settings__t.html#86073d524a713c1166821c05d4c9635b" title="GOP settings;.">gop</a>.<a class="code" href="structgop__settings__t.html#3d8b81693cfeade850616e3b0f5c825b" title="num units per tick;">num_units</a>;
    <span class="keywordtype">int</span> time_scale = settings-&gt;<a class="code" href="structv4e__settings__t.html#86073d524a713c1166821c05d4c9635b" title="GOP settings;.">gop</a>.<a class="code" href="structgop__settings__t.html#3b8273f968d83a8032a075adf3f7c751" title="time scale (field_rate = time_scale/num_units);">time_scale</a>/2;
    int64_t sec, remain;
    ts = num * num_units;
    ts = ts * ONE_SEC / time_scale;
    sec = ts / ONE_SEC;
    remain = ts % ONE_SEC;
    ts = sec * ONE_SEC + remain;
    <span class="keywordflow">return</span> ts;
}


<span class="keyword">static</span> <span class="keywordtype">void</span> on_nal_unit(<a class="code" href="structmedia__sample__t.html">media_sample_t</a> *ms)
{
    <span class="keyword">static</span> byte start_code[4] = {0,0,0,1};
    <span class="comment">// Annex B format: 4 bytes start code and NAL unit RBSP contents</span>
    <span class="keywordflow">if</span>(is_write_general_output != 0)
    {
        writeFile(start_code, 4);
        writeFile(ms-&gt;<a class="code" href="structmedia__sample__t.html#fc893318b1f2b8f9412090e104d33f9e" title="data buffer">data</a>, ms-&gt;<a class="code" href="structmedia__sample__t.html#aeaf60c3f4396ad4b4d24f1ffe62eca5" title="total used size, bytes">used_size</a>);
    }
    total_bytes += (ms-&gt;<a class="code" href="structmedia__sample__t.html#aeaf60c3f4396ad4b4d24f1ffe62eca5" title="total used size, bytes">used_size</a> + 4);

    <span class="comment">// Write multi-stream files</span>
    multistream_write(ms);

    <span class="keywordflow">if</span> (verbose)
        report_media_sample(total_samples, ms);
    <span class="keywordflow">if</span> (verbose &gt;= 2)
    {
        <span class="keywordflow">if</span> (ms-&gt;<a class="code" href="structmedia__sample__t.html#5ada7e729c181ffe9d8d01433c40586b" title="see last_in_pict_e enum">is_last_in_pict</a> &gt; <a class="code" href="v4__types_8h.html#eb7ee786ade8f9b6fb90177315a530620b2620e7b1aa45e930c4e8cdf9d60d32" title="not last in any sense">NOT_LAST</a>)
        {
            verbose_print(2, <span class="stringliteral">"[%08d]"</span>, (<span class="keywordtype">int</span>)(ms-&gt;<a class="code" href="structmedia__sample__t.html#9fd3638e794327d6e62d052ca6da4197" title="external timestamp">timestamp</a>/10000));
            <span class="keywordflow">switch</span> (ms-&gt;<a class="code" href="structmedia__sample__t.html#5ada7e729c181ffe9d8d01433c40586b" title="see last_in_pict_e enum">is_last_in_pict</a>)
            {
            <span class="keywordflow">case</span> <a class="code" href="v4__types_8h.html#eb7ee786ade8f9b6fb90177315a5306224de2f0c37a501a8b60d7cf2d905f49f" title="last in some layer (used in SVC coding">LAST_IN_LAYER</a>:
                verbose_print(2, <span class="stringliteral">"------------&gt; layer\n"</span>);
                <span class="keywordflow">break</span>;
            <span class="keywordflow">case</span> <a class="code" href="v4__types_8h.html#eb7ee786ade8f9b6fb90177315a53062c98a008164140be70cde36cb6479abb5" title="last in one field (picture), but not last in frame">LAST_IN_PICT</a>:
                verbose_print(2, <span class="stringliteral">"------------&gt; pict\n"</span>);
                <span class="keywordflow">break</span>;
            <span class="keywordflow">case</span> <a class="code" href="v4__types_8h.html#eb7ee786ade8f9b6fb90177315a53062518d8eb4ab57ba7eab316acdc9b5484b" title="last in frame, but not last in &amp;quot;chunk&amp;quot;">LAST_IN_FRAME</a>:
                verbose_print(2, <span class="stringliteral">"-------------------------------------&gt; frame %d\n"</span>, frame_num++);
                <span class="keywordflow">break</span>;
            }
        }
    }
    <span class="comment">// application responsibility is to release media sample after use</span>
    <a class="code" href="v4__media__sample_8h.html#b9ff1ee2911ee3fd4fdb6dd497a91e0f" title="Free previously allocated media sample;.">v4_free_media_sample</a>(ms);
    total_samples++;
}

<span class="keyword">static</span> <span class="keywordtype">int</span> receive_nal_callback(<span class="keywordtype">void</span> *context, <a class="code" href="structmedia__sample__t.html">media_sample_t</a> *ms)
{
    <span class="keyword">static</span> <span class="keywordtype">int</span> s_flag = 0;
    <span class="keywordflow">if</span> (s_flag != 0)
    {
        verbose_print(0, <span class="stringliteral">"*** receive_nal_callback(): entry violation [%d]!!! \n"</span>, s_flag);
        exit(0);
    }
    s_flag += 1;
    <span class="keywordflow">if</span> (ms)
        on_nal_unit(ms);
    <span class="keywordflow">else</span>
        eos = 1;
    s_flag -= 1;
    <span class="keywordflow">return</span> 0;
}

<span class="keyword">static</span> <span class="keywordtype">int</span> prepareSettings(<a class="code" href="structv4e__settings__t.html" title="All encoder settings.">v4e_settings_t</a> *settings, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
{
    <span class="keywordtype">int</span> i, rc;
    <span class="comment">// in order to avoid collisions application has to specify size of settings structure</span>
    settings-&gt;<a class="code" href="structv4e__settings__t.html#befb939f42d1b2d5b76358ce61586bdd" title="put a size of your structure here - to prevent problems with version compatibility...">size</a> = <span class="keyword">sizeof</span>(<a class="code" href="structv4e__settings__t.html" title="All encoder settings.">v4e_settings_t</a>);
    rc = <a class="code" href="group__enc__func.html#g697e01cb802f6b569ff8774a530fc1ab" title="Provide default encoder settings into given structure.">v4e_default_settings</a>(settings);
    <span class="keywordflow">if</span> (rc != <a class="code" href="group__return__codes.html#gb9dfadfbdfd9326b6a3b31988cd73957" title="Everything is OK.">VSSH_OK</a>)
    {
        <span class="keywordflow">if</span> (rc == <a class="code" href="group__return__codes.html#g30808e48eec74719610a650cdb393290" title="Error: wrong function argument value.">VSSH_ERR_ARG</a>)
            verbose_print(0, <span class="stringliteral">"Error: invalid version of encoder settings linked in (%d)\n"</span>, rc);
        <span class="keywordflow">else</span>
            verbose_print(0, <span class="stringliteral">"Error: v4e_default_settings() failed (%d)\n"</span>, rc);
        <span class="keywordflow">return</span> rc;
    }

    <span class="comment">// before reading config file setup some default values according to command line arguments</span>
    <span class="keywordflow">if</span> (colorspace &gt;= 0)
    {
        <span class="keywordflow">switch</span> (colorspace)
        {
        <span class="keywordflow">case</span>  <a class="code" href="v4__types_8h.html#16b49001d76a0fe1b71b295aa706f6d6d2663823dc58cb2ec3eb5fd5c31f03e8" title="YUV 4:0:0 planar.">COLORSPACE_E_YUV400</a>: settings-&gt;<a class="code" href="structv4e__settings__t.html#334d337e4a8f193bf7ffb81a2bc1d21a" title="Preprocessing settings;.">preproc</a>.<a class="code" href="structpreproc__settings__t.html#d53bdc4dda309d293108e51d6bca7c1a" title="internal data, do not use it!">chroma_format_idc</a> = <a class="code" href="v4__types_8h.html#bbda742b3585721c1e90fee756df61eb82c5608021c77ceb16825daebd39856f">YUV_400_IDC</a>; <span class="keywordflow">break</span>;
        <span class="keywordflow">case</span>  <a class="code" href="v4__types_8h.html#16b49001d76a0fe1b71b295aa706f6d662e0455a48c1917b4814c81e105a9542" title="YUV 4:2:2 planar.">COLORSPACE_E_YUV422</a>: settings-&gt;<a class="code" href="structv4e__settings__t.html#334d337e4a8f193bf7ffb81a2bc1d21a" title="Preprocessing settings;.">preproc</a>.<a class="code" href="structpreproc__settings__t.html#d53bdc4dda309d293108e51d6bca7c1a" title="internal data, do not use it!">chroma_format_idc</a> = <a class="code" href="v4__types_8h.html#bbda742b3585721c1e90fee756df61eb5bf15b1c21b6ac8573d77a8d925b03f8">YUV_422_IDC</a>; <span class="keywordflow">break</span>;
        <span class="keywordflow">default</span>: settings-&gt;<a class="code" href="structv4e__settings__t.html#334d337e4a8f193bf7ffb81a2bc1d21a" title="Preprocessing settings;.">preproc</a>.<a class="code" href="structpreproc__settings__t.html#d53bdc4dda309d293108e51d6bca7c1a" title="internal data, do not use it!">chroma_format_idc</a> = <a class="code" href="v4__types_8h.html#bbda742b3585721c1e90fee756df61eb7699befcf9ed133507018f8d345eda22">YUV_420_IDC</a>; <span class="keywordflow">break</span>;
        }
    }
    <span class="keywordflow">if</span> ((bits_per_pel &gt; 8) &amp;&amp; (bits_per_pel &lt;= 14))
    {
        settings-&gt;<a class="code" href="structv4e__settings__t.html#d5e9ef1ce39f150fadd44e7cfa95e14f" title="input picture description;">input</a>.<a class="code" href="structinput__picture__t.html#9faa158cf534bfadaf2526bfa5b9c934" title="size of one pixel sample, bytes (default 1);">sample_size</a> = 2;
        settings-&gt;<a class="code" href="structv4e__settings__t.html#d5e9ef1ce39f150fadd44e7cfa95e14f" title="input picture description;">input</a>.<a class="code" href="structinput__picture__t.html#1b8620ef86e6b450fc702c86a9ac17c7" title="number of significant bits (default 8);">significant_bits</a> = bits_per_pel;
        settings-&gt;<a class="code" href="structv4e__settings__t.html#e1962380d154d1aecb2f7192803531ef" title="luma bit depth">bit_depth_luma</a> = bits_per_pel;
        settings-&gt;<a class="code" href="structv4e__settings__t.html#2d1a533866192b80f2afd71d17da5eff" title="chroma bit depth">bit_depth_chroma</a> = bits_per_pel;
    }

    <span class="comment">// read encoder config file</span>
    <span class="keywordflow">if</span> (config_file)
    {
        rc = <a class="code" href="group__enc__func.html#g90295a40bf61908245fe520674a38949" title="Load given configuration text file.">v4e_read_config_file</a>(settings, config_file);
        <span class="keywordflow">if</span> (rc != <a class="code" href="group__return__codes.html#gb9dfadfbdfd9326b6a3b31988cd73957" title="Everything is OK.">VSSH_OK</a>)
        {
            verbose_print(0, <span class="stringliteral">"Error: can't open config file [%s]\n"</span>, config_file);
            <span class="keywordflow">return</span> rc;
        }
    }

    <span class="keywordflow">if</span>(settings-&gt;<a class="code" href="structv4e__settings__t.html#d5e9ef1ce39f150fadd44e7cfa95e14f" title="input picture description;">input</a>.<a class="code" href="structinput__picture__t.html#48eeb84242667de595027a4ab51725a1" title="picture height, pixels">height</a> &lt; 0)
    {
        rgb_switch = 1;
        settings-&gt;<a class="code" href="structv4e__settings__t.html#d5e9ef1ce39f150fadd44e7cfa95e14f" title="input picture description;">input</a>.<a class="code" href="structinput__picture__t.html#48eeb84242667de595027a4ab51725a1" title="picture height, pixels">height</a> = abs(settings-&gt;<a class="code" href="structv4e__settings__t.html#d5e9ef1ce39f150fadd44e7cfa95e14f" title="input picture description;">input</a>.<a class="code" href="structinput__picture__t.html#48eeb84242667de595027a4ab51725a1" title="picture height, pixels">height</a>);
    }

    <span class="comment">// command line arguments override encoder settings:</span>
    <span class="keywordflow">if</span> (mt == 0)
    {
        settings-&gt;<a class="code" href="structv4e__settings__t.html#4ff69585460e11c35b5bcb2410875de8" title="multi-threading settings;">mt</a>.<a class="code" href="structmt__settings__t.html#6d863424c8218ce27158b6428b02b075" title="flag to disable multi-threading;">disable</a> = 1;
    }
    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mt &gt; 0)
    {
        settings-&gt;<a class="code" href="structv4e__settings__t.html#4ff69585460e11c35b5bcb2410875de8" title="multi-threading settings;">mt</a>.<a class="code" href="structmt__settings__t.html#6d863424c8218ce27158b6428b02b075" title="flag to disable multi-threading;">disable</a> = 0;
        settings-&gt;<a class="code" href="structv4e__settings__t.html#4ff69585460e11c35b5bcb2410875de8" title="multi-threading settings;">mt</a>.<a class="code" href="structmt__settings__t.html#92c60b5ecf0614ab5ba0cfee4808d6c2" title="number of worker threads to run, zero means automatic value equal to number of CPUs;...">num_threads</a> = mt;
    }

    <span class="keywordflow">if</span> (frame_width &gt; 0)
    {
        settings-&gt;<a class="code" href="structv4e__settings__t.html#d5e9ef1ce39f150fadd44e7cfa95e14f" title="input picture description;">input</a>.<a class="code" href="structinput__picture__t.html#350e9e105180c1c48f533bd331558189" title="picture width, pixels">width</a>  = frame_width;
    }
    <span class="keywordflow">if</span> (frame_height &gt; 0)
    {
        settings-&gt;<a class="code" href="structv4e__settings__t.html#d5e9ef1ce39f150fadd44e7cfa95e14f" title="input picture description;">input</a>.<a class="code" href="structinput__picture__t.html#48eeb84242667de595027a4ab51725a1" title="picture height, pixels">height</a> = frame_height;
    }

    <span class="keywordflow">if</span> (colorspace &gt;= 0)
    {
        settings-&gt;<a class="code" href="structv4e__settings__t.html#d5e9ef1ce39f150fadd44e7cfa95e14f" title="input picture description;">input</a>.<a class="code" href="structinput__picture__t.html#15054ffcf190e18a6179b7ae193a759f" title="colorspace specification;">colorspace</a> = (<a class="code" href="v4__types_8h.html#16b49001d76a0fe1b71b295aa706f6d6" title="known colorspace formats">colorspace_e</a>)colorspace;
    }
    <span class="keywordflow">if</span> (frame_rate &gt; 0)
    {
        settings-&gt;<a class="code" href="structv4e__settings__t.html#86073d524a713c1166821c05d4c9635b" title="GOP settings;.">gop</a>.<a class="code" href="structgop__settings__t.html#3d8b81693cfeade850616e3b0f5c825b" title="num units per tick;">num_units</a> = 10000;
        settings-&gt;<a class="code" href="structv4e__settings__t.html#86073d524a713c1166821c05d4c9635b" title="GOP settings;.">gop</a>.<a class="code" href="structgop__settings__t.html#3b8273f968d83a8032a075adf3f7c751" title="time scale (field_rate = time_scale/num_units);">time_scale</a> = 2*frame_rate;
    }
    <span class="keywordflow">if</span> (bitrate &gt; 0)
    {
        settings-&gt;<a class="code" href="structv4e__settings__t.html#673f06b50e9489afa73087ee5baeb146" title="Rate Control settings;.">rc</a>.<a class="code" href="structrate__control__settings__t.html#667f38da2f2c7f41c9584b1534d1d3d1" title="desired bitrate (kbits per sec);">kbps</a> = bitrate;
    }
    <span class="keywordflow">if</span> (fp_type &gt;= 0)
    {
        <span class="keywordflow">if</span>(fp_type == 3 || fp_type == 4) <span class="comment">// make sure that frame_packing_type is supported</span>
        {
            settings-&gt;<a class="code" href="structv4e__settings__t.html#5d016482ee0acd2a2dfc89e1a6600e59" title="SEI messages settings;.">sei</a>.<a class="code" href="structsei__settings__t.html#0e4a2e5bfbeefdf560b635661e861098" title="enable frame packing arrangement SEI (0/1/2)">frame_packing_flag</a> = 1;
            settings-&gt;<a class="code" href="structv4e__settings__t.html#5d016482ee0acd2a2dfc89e1a6600e59" title="SEI messages settings;.">sei</a>.<a class="code" href="structsei__settings__t.html#05f9d1668a31f4fdf1e34025660d365b" title="frame packing type">frame_packing_type</a> = fp_type;
            settings-&gt;<a class="code" href="structv4e__settings__t.html#0eb9ab59c4fc040a3d4710b5ccfe617d" title="svc encoding settings">svc</a>.<a class="code" href="structsvc__settings__t.html#b9a25fb28ebf4cce9e1d69d9f2ea52b7" title="number of svc-layers (0 means no SVC)">num_layers</a> = 0; <span class="comment">//make sure that it will AVC encoding only</span>
            settings-&gt;<a class="code" href="structv4e__settings__t.html#0eb9ab59c4fc040a3d4710b5ccfe617d" title="svc encoding settings">svc</a>.<a class="code" href="structsvc__settings__t.html#408e8588246f8a76c37050f56695297b">multistream_mode</a> = 0;
            <span class="keywordflow">if</span> (fp_type == 3 || fp_type == 4) 
                settings-&gt;<a class="code" href="structv4e__settings__t.html#6fd95cb2b9edaa28ef8b8d3571ab75e6" title="other flags">enc_flags</a> |= <a class="code" href="v4e__settings_8h.html#4de068ec2e75b3c3dd7aaa1bb106edbba0bf359d1532e2a93109ed8b94bfca77" title="used together with sei.frame_packing flags. Force encoder to perform actual packing...">ENC_FRAME_PACKING</a>; 
        }
    }
    <span class="comment">// now scan all command line arguments for a pairs like "name=value"</span>
    <span class="comment">// and try to apply them to encoder settings structure</span>
    <span class="keywordflow">for</span> (i=1; i&lt;argc; i++)
    {
        <span class="keywordtype">char</span> *param = argv[i];
        <span class="keywordflow">if</span> (strchr(param, <span class="charliteral">'='</span>))
        {
            <span class="keywordtype">int</span> len = (int)strlen(param);
            <span class="keywordtype">int</span> rc = <a class="code" href="group__enc__func.html#g9416903397e58cf2fb728d78d167c121" title="Parse given character string buffer into encoder settings.">v4e_buf2settings</a>(settings, param, len);
            <span class="keywordflow">if</span> (rc == <a class="code" href="group__return__codes.html#gb9dfadfbdfd9326b6a3b31988cd73957" title="Everything is OK.">VSSH_OK</a>)
            {
                verbose_print(1, <span class="stringliteral">"*** override [%s]\n"</span>, param);
            }
        }
    }
    <span class="keywordflow">return</span> 0;
}

<span class="keyword">static</span> <span class="keywordtype">void</span> enc_change_bitrate(<span class="keywordtype">void</span> *handle, <a class="code" href="structv4e__settings__t.html" title="All encoder settings.">v4e_settings_t</a> *settings, <span class="keywordtype">int</span> ratio)
{
    <span class="keywordtype">int</span> rc, oldkbps, newkbps, i, svcratio;
    <span class="keywordflow">if</span> ((ratio &gt; 0) &amp;&amp; (settings-&gt;<a class="code" href="structv4e__settings__t.html#673f06b50e9489afa73087ee5baeb146" title="Rate Control settings;.">rc</a>.<a class="code" href="structrate__control__settings__t.html#667f38da2f2c7f41c9584b1534d1d3d1" title="desired bitrate (kbits per sec);">kbps</a> &gt; 0))
    {
        oldkbps = settings-&gt;<a class="code" href="structv4e__settings__t.html#673f06b50e9489afa73087ee5baeb146" title="Rate Control settings;.">rc</a>.<a class="code" href="structrate__control__settings__t.html#667f38da2f2c7f41c9584b1534d1d3d1" title="desired bitrate (kbits per sec);">kbps</a>;
        newkbps = settings-&gt;<a class="code" href="structv4e__settings__t.html#673f06b50e9489afa73087ee5baeb146" title="Rate Control settings;.">rc</a>.<a class="code" href="structrate__control__settings__t.html#667f38da2f2c7f41c9584b1534d1d3d1" title="desired bitrate (kbits per sec);">kbps</a> * ratio / 100;
        settings-&gt;<a class="code" href="structv4e__settings__t.html#673f06b50e9489afa73087ee5baeb146" title="Rate Control settings;.">rc</a>.<a class="code" href="structrate__control__settings__t.html#667f38da2f2c7f41c9584b1534d1d3d1" title="desired bitrate (kbits per sec);">kbps</a> = newkbps;
        verbose_print(2, <span class="stringliteral">"*** change-bitrate: %d"</span>, newkbps);
        rc = <a class="code" href="group__enc__func.html#g45c6c1f410d2955fbb708b561c53cb14" title="Change current bitrate and frame rate values on-the-fly;.">v4e_change_bitrate_and_framerate</a>(handle, newkbps, 0, 0);
        <span class="keywordflow">if</span> (settings-&gt;<a class="code" href="structv4e__settings__t.html#673f06b50e9489afa73087ee5baeb146" title="Rate Control settings;.">rc</a>.<a class="code" href="structrate__control__settings__t.html#667f38da2f2c7f41c9584b1534d1d3d1" title="desired bitrate (kbits per sec);">kbps</a> &gt; 0)
        {
            <span class="keywordflow">for</span> (i=0; i&lt;settings-&gt;<a class="code" href="structv4e__settings__t.html#0eb9ab59c4fc040a3d4710b5ccfe617d" title="svc encoding settings">svc</a>.<a class="code" href="structsvc__settings__t.html#b9a25fb28ebf4cce9e1d69d9f2ea52b7" title="number of svc-layers (0 means no SVC)">num_layers</a>; i++)
            {
                svcratio = settings-&gt;<a class="code" href="structv4e__settings__t.html#0eb9ab59c4fc040a3d4710b5ccfe617d" title="svc encoding settings">svc</a>.<a class="code" href="structsvc__settings__t.html#fc8f65b519af39d1a8548884b49ed5a3" title="Last valid element of this array is related to the to the most “rich” layer.">layer</a>[i].<a class="code" href="structsvc__layer__settings__t.html#a730738dd24fa4d7a0267c1620519166" title="desired bitrate (for this plus below levels) Must be greater then kbps for previous...">kbps</a> * 100 / oldkbps;
                newkbps = oldkbps * ratio / 100;
                newkbps = newkbps * svcratio / 100;
                settings-&gt;<a class="code" href="structv4e__settings__t.html#0eb9ab59c4fc040a3d4710b5ccfe617d" title="svc encoding settings">svc</a>.<a class="code" href="structsvc__settings__t.html#fc8f65b519af39d1a8548884b49ed5a3" title="Last valid element of this array is related to the to the most “rich” layer.">layer</a>[i].<a class="code" href="structsvc__layer__settings__t.html#a730738dd24fa4d7a0267c1620519166" title="desired bitrate (for this plus below levels) Must be greater then kbps for previous...">kbps</a> = newkbps;
                verbose_print(2, <span class="stringliteral">", %d"</span>, newkbps);
                rc = <a class="code" href="group__enc__func.html#g40ffbf5d2dce074f2634acb0688ade65" title="Change bitrate and frame rate for paricular svc layer values on-the-fly;.">v4e_change_svc_bitrate_and_framerate</a>(handle, i, newkbps, 0, 0);
            }
        }
        verbose_print(2, <span class="stringliteral">"\n"</span>);
    }
}


<span class="keyword">static</span> <span class="keywordtype">char</span> *file_dualpass = <span class="stringliteral">"v4enc.dualpass.log"</span>;
<span class="keyword">static</span> <span class="keywordtype">int</span> dualpass_before(<span class="keywordtype">void</span> *henc, <a class="code" href="structv4e__settings__t.html" title="All encoder settings.">v4e_settings_t</a> *settings)
{
    <span class="keywordtype">int</span> rc, fsize;
    <a class="code" href="structmedia__sample__t.html">media_sample_t</a> *pms;
    <span class="comment">// load first pass results before second pass encoding</span>
    <span class="keywordflow">if</span> ((settings-&gt;<a class="code" href="structv4e__settings__t.html#673f06b50e9489afa73087ee5baeb146" title="Rate Control settings;.">rc</a>.<a class="code" href="structrate__control__settings__t.html#6035018e99cb75d477cd5d75291d69d8" title="rate control mode;">type</a>&amp;0xf) == <a class="code" href="v4e__settings_8h.html#ba66a1cb381789f7785de43b8b66c3bceed9c9ea862fb55ac746bbf853459b76" title="second pass of dual pass mode;">RATE_CONTROL_DUAL_PASS_1</a>)
    {
        FILE *f = fopen(file_dualpass, <span class="stringliteral">"rb"</span>);
        <span class="keywordflow">if</span> (!f)
        {
            verbose_print(0, <span class="stringliteral">"*** Error: dual pass log file not found [%s]\n"</span>, file_dualpass);
            <span class="keywordflow">return</span> <a class="code" href="group__return__codes.html#g94d45d02bd2f2ac857e1469b591bbeb4" title="Error: general fault.">VSSH_ERR_GENERAL</a>;
        }
        fseek (f, 0, SEEK_END);
        fsize = ftell(f);
        fseek(f, 0, SEEK_SET);
        pms = <a class="code" href="v4__media__sample_8h.html#5b91ca8401d597a0975f5f13837cfba0" title="Allocate a new media sample filling structure fields with information from frame...">v4_alloc_media_sample</a>(fsize, NULL);
        <span class="keywordflow">if</span> (!pms)
        {
            verbose_print(0, <span class="stringliteral">"Error: can't allocate dual pass buffer [%d] bytes\n"</span>, fsize);
            fclose(f);
            <span class="keywordflow">return</span> <a class="code" href="group__return__codes.html#ge732002a834dbca447aef0caa3eb69e9" title="Error: not enough memory.">VSSH_ERR_MEMORY</a>;
        }
        fread(pms-&gt;<a class="code" href="structmedia__sample__t.html#fc893318b1f2b8f9412090e104d33f9e" title="data buffer">data</a>, fsize, 1, f);
        pms-&gt;<a class="code" href="structmedia__sample__t.html#aeaf60c3f4396ad4b4d24f1ffe62eca5" title="total used size, bytes">used_size</a> = fsize;
        rc = <a class="code" href="group__enc__func.html#g58fe7c6063a457fa2d2a7f1713fa739f" title="Provide encoder with first pass results of dual-pass rate-control.">v4e_set_dual_pass_log</a>(henc, pms);
        fclose(f);
    }
    <span class="keywordflow">return</span> <a class="code" href="group__return__codes.html#gb9dfadfbdfd9326b6a3b31988cd73957" title="Everything is OK.">VSSH_OK</a>;
}
<span class="keyword">static</span> <span class="keywordtype">int</span> dualpass_after(<span class="keywordtype">void</span> *henc, <a class="code" href="structv4e__settings__t.html" title="All encoder settings.">v4e_settings_t</a> *settings)
{
    <span class="keywordtype">int</span> rc;
    <span class="comment">// save results after first pass encoding</span>
    <span class="keywordflow">if</span> ((settings-&gt;<a class="code" href="structv4e__settings__t.html#673f06b50e9489afa73087ee5baeb146" title="Rate Control settings;.">rc</a>.<a class="code" href="structrate__control__settings__t.html#6035018e99cb75d477cd5d75291d69d8" title="rate control mode;">type</a>&amp;0xf) == <a class="code" href="v4e__settings_8h.html#ba66a1cb381789f7785de43b8b66c3bc7b57a2935226046cfa76e6a16f49ce37" title="first pass of dual pass mode;">RATE_CONTROL_DUAL_PASS_0</a>)
    {
        FILE *f = fopen(file_dualpass, <span class="stringliteral">"wb"</span>);
        <a class="code" href="structmedia__sample__t.html">media_sample_t</a> *pms = NULL;
        <span class="keywordflow">if</span> (!f)
        {
            verbose_print(0, <span class="stringliteral">"*** Error: can't open dual pass log file [%s]\n"</span>, file_dualpass);
            <span class="keywordflow">return</span> <a class="code" href="group__return__codes.html#g94d45d02bd2f2ac857e1469b591bbeb4" title="Error: general fault.">VSSH_ERR_GENERAL</a>;
        }
        rc = <a class="code" href="group__enc__func.html#gd570a87ab828e5921161544aed9284d4" title="Retrieve results of first pass of dual-pass rate-control.">v4e_get_dual_pass_log</a>(henc, &amp;pms);
        <span class="keywordflow">if</span> (!pms)
        {
            verbose_print(0, <span class="stringliteral">"Error: can't retrieve dual pass bytes\n"</span>);
            fclose(f);
            <span class="keywordflow">return</span> <a class="code" href="group__return__codes.html#ge732002a834dbca447aef0caa3eb69e9" title="Error: not enough memory.">VSSH_ERR_MEMORY</a>;
        }
        fwrite(pms-&gt;<a class="code" href="structmedia__sample__t.html#fc893318b1f2b8f9412090e104d33f9e" title="data buffer">data</a>, pms-&gt;<a class="code" href="structmedia__sample__t.html#aeaf60c3f4396ad4b4d24f1ffe62eca5" title="total used size, bytes">used_size</a>, 1, f);
        <a class="code" href="v4__media__sample_8h.html#b9ff1ee2911ee3fd4fdb6dd497a91e0f" title="Free previously allocated media sample;.">v4_free_media_sample</a>(pms);
        fclose(f);
    }
    <span class="keywordflow">return</span> <a class="code" href="group__return__codes.html#gb9dfadfbdfd9326b6a3b31988cd73957" title="Everything is OK.">VSSH_OK</a>;
}


<span class="preprocessor">#ifdef SVC_EXTENSION</span>
<span class="preprocessor"></span><span class="comment">//#define VSS_MB_TYPES_DUMP</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="comment">// for debugging</span>
<span class="preprocessor">#ifdef VSS_MB_TYPES_DUMP</span>
<span class="preprocessor"></span><span class="keyword">extern</span> <span class="keywordtype">int</span> g_dbg_num_layers;
<span class="keyword">extern</span> <span class="keywordtype">int</span> g_num_b_frames;
<span class="keyword">extern</span> <span class="keywordtype">void</span> mb_types_dbg_drawing_close();

<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="comment">/*</span>
<span class="comment">This program demonstrates synchronous input approach with several (9) buffers.</span>
<span class="comment">Encoder API function "v4e_set_frame_ex()" freely accepts 8 input frames and then starts blocking</span>
<span class="comment">the caller waiting while the next frame becomes released. Using exactly (9) buffers guarantees</span>
<span class="comment">that after every call to "v4e_set_frame_ex()" next frame in the array will be safe for use (ring buffer).</span>
<span class="comment">*/</span>
<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
{
    <a class="code" href="structv4e__settings__t.html" title="All encoder settings.">v4e_settings_t</a> settings;
    <a class="code" href="structv4e__settings__t.html" title="All encoder settings.">v4e_settings_t</a> actual_settings;
    <span class="keywordtype">void</span> *handle;
    <a class="code" href="structmedia__sample__t.html">media_sample_t</a> *ms;
    <a class="code" href="structv4__frame__release__t.html" title="Define callback functions in conjunction with appropriate context.">v4_frame_release_t</a>  frame_release_local;
    <a class="code" href="structv4__frame__release__t.html" title="Define callback functions in conjunction with appropriate context.">v4_frame_release_t</a> *frame_release = NULL;
    <a class="code" href="structv4__receive__nal__t.html">v4_receive_nal_t</a>    nal_receive_local;
    <a class="code" href="structv4__receive__nal__t.html">v4_receive_nal_t</a>   *nal_receive = NULL;
    raw_frame_ex_t *raw_frame;
    <span class="keywordtype">int</span> num_frame, total_frames;
    <span class="keywordtype">int</span> rc, i, again, eof;
    <a class="code" href="v4timer_8h.html#a27b207a9c07e9d06d68c998a758f708">timer_clock_t</a> start_time;
    <a class="code" href="v4timer_8h.html#dfcc0da44bfb44713477a0115d2bef76">timer_delta_t</a> delta;
    <span class="keywordtype">int</span> total_ms;
    <a class="code" href="structarg__ctx__t.html">arg_ctx_t</a> arg_ctx;
    <span class="keywordtype">int</span> skip_counter;

<span class="preprocessor">#ifdef _CRT_DEBUG_</span>
<span class="preprocessor"></span>    _CrtMemState _ms1, _ms2, _ms3;
    _CrtMemCheckpoint(&amp;_ms1);
    _CrtSetDbgFlag(_CRTDBG_ALLOC_MEM_DF|_CRTDBG_CHECK_ALWAYS_DF|_CRTDBG_LEAK_CHECK_DF);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="comment">// print codec library version</span>
    verbose_print(0, <span class="stringliteral">"sample encoder application\n"</span>);
    print_codec_info();

    <span class="comment">// process command line arguments</span>
    arg_ctx.<a class="code" href="structarg__ctx__t.html#6cb222d46e62fdba8f25044dc8fda97d">args</a> = all_args;
    arg_ctx.<a class="code" href="structarg__ctx__t.html#3ceca726f956a04bf2cda26a4cd9a3b6">cnt</a>  = all_args_cnt;
    <span class="keywordflow">if</span> (argc &lt; 2)
    {
        usage();
        print_args(&amp;arg_ctx);
        <span class="keywordflow">return</span> 0;
    }

    settings.<a class="code" href="structv4e__settings__t.html#60910d442ddcafa5622b39e6bfa92deb">ext_data_string</a> = NULL;

    read_args(&amp;arg_ctx, argc, argv);
    <span class="keywordflow">if</span> (verbose) dump_args(&amp;arg_ctx);

    <span class="comment">// prepare encoder settings</span>
    rc = prepareSettings(&amp;settings, argc, argv);
    <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> -1;

    <span class="keywordflow">if</span>(change_bitrate_period &gt; 0 &amp;&amp; settings.<a class="code" href="structv4e__settings__t.html#5d016482ee0acd2a2dfc89e1a6600e59" title="SEI messages settings;.">sei</a>.<a class="code" href="structsei__settings__t.html#32ed391a71323dc5f982a66e3818f770" title="enable picture timing SEI messages (0/1/2);">pic_timing_flag</a> &gt; 0)
    {
        settings.<a class="code" href="structv4e__settings__t.html#5d016482ee0acd2a2dfc89e1a6600e59" title="SEI messages settings;.">sei</a>.<a class="code" href="structsei__settings__t.html#32ed391a71323dc5f982a66e3818f770" title="enable picture timing SEI messages (0/1/2);">pic_timing_flag</a> = 0;
        verbose_print(0, <span class="stringliteral">"\nWarning: picture timing is disabled due to change-bitrate-period option is in use\n\n"</span>);
    }

    <span class="keywordflow">if</span>(settings.<a class="code" href="structv4e__settings__t.html#0eb9ab59c4fc040a3d4710b5ccfe617d" title="svc encoding settings">svc</a>.<a class="code" href="structsvc__settings__t.html#b9a25fb28ebf4cce9e1d69d9f2ea52b7" title="number of svc-layers (0 means no SVC)">num_layers</a> &gt; 0 &amp;&amp; (settings.<a class="code" href="structv4e__settings__t.html#0eb9ab59c4fc040a3d4710b5ccfe617d" title="svc encoding settings">svc</a>.<a class="code" href="structsvc__settings__t.html#408e8588246f8a76c37050f56695297b">multistream_mode</a> == <a class="code" href="v4e__settings_8h.html#73683698f52b7fac59e9fa6cb29699a71d5b55cd95b04c2ec8cf10bd63b59e12" title="AVC - generate several AVC streams.">MULTISTREAM_MODE_AVC</a> || settings.<a class="code" href="structv4e__settings__t.html#0eb9ab59c4fc040a3d4710b5ccfe617d" title="svc encoding settings">svc</a>.<a class="code" href="structsvc__settings__t.html#408e8588246f8a76c37050f56695297b">multistream_mode</a> == <a class="code" href="v4e__settings_8h.html#73683698f52b7fac59e9fa6cb29699a707978eefce87eb9a860050a53491ff58" title="MVC - generate MVC stream.">MULTISTREAM_MODE_MVC</a>) )
    {
        <span class="keywordflow">if</span>(output_file != NULL)
        {
            strcpy(output_file_ms, output_file);
            <span class="keywordflow">if</span>(settings.<a class="code" href="structv4e__settings__t.html#0eb9ab59c4fc040a3d4710b5ccfe617d" title="svc encoding settings">svc</a>.<a class="code" href="structsvc__settings__t.html#408e8588246f8a76c37050f56695297b">multistream_mode</a> == <a class="code" href="v4e__settings_8h.html#73683698f52b7fac59e9fa6cb29699a71d5b55cd95b04c2ec8cf10bd63b59e12" title="AVC - generate several AVC streams.">MULTISTREAM_MODE_AVC</a>)
            {
                output_file = NULL;
            }
        }
        <span class="keywordflow">else</span>
        {
            <span class="comment">// Null outputs support</span>
            output_file_ms[0] = 0;
        }
    }

    num_dep_views = settings.<a class="code" href="structv4e__settings__t.html#0eb9ab59c4fc040a3d4710b5ccfe617d" title="svc encoding settings">svc</a>.<a class="code" href="structsvc__settings__t.html#408e8588246f8a76c37050f56695297b">multistream_mode</a> != <a class="code" href="v4e__settings_8h.html#73683698f52b7fac59e9fa6cb29699a707978eefce87eb9a860050a53491ff58" title="MVC - generate MVC stream.">MULTISTREAM_MODE_MVC</a> ? 0 : settings.<a class="code" href="structv4e__settings__t.html#0eb9ab59c4fc040a3d4710b5ccfe617d" title="svc encoding settings">svc</a>.<a class="code" href="structsvc__settings__t.html#b9a25fb28ebf4cce9e1d69d9f2ea52b7" title="number of svc-layers (0 means no SVC)">num_layers</a>;

    <span class="keywordflow">if</span>(settings.<a class="code" href="structv4e__settings__t.html#5d016482ee0acd2a2dfc89e1a6600e59" title="SEI messages settings;.">sei</a>.<a class="code" href="structsei__settings__t.html#0e4a2e5bfbeefdf560b635661e861098" title="enable frame packing arrangement SEI (0/1/2)">frame_packing_flag</a>)
    {
        <span class="keywordflow">if</span>(settings.<a class="code" href="structv4e__settings__t.html#5d016482ee0acd2a2dfc89e1a6600e59" title="SEI messages settings;.">sei</a>.<a class="code" href="structsei__settings__t.html#05f9d1668a31f4fdf1e34025660d365b" title="frame packing type">frame_packing_type</a> == 3 || settings.<a class="code" href="structv4e__settings__t.html#5d016482ee0acd2a2dfc89e1a6600e59" title="SEI messages settings;.">sei</a>.<a class="code" href="structsei__settings__t.html#05f9d1668a31f4fdf1e34025660d365b" title="frame packing type">frame_packing_type</a> == 4) 
        {
            num_dep_views = 1;
            settings.<a class="code" href="structv4e__settings__t.html#6fd95cb2b9edaa28ef8b8d3571ab75e6" title="other flags">enc_flags</a> |= <a class="code" href="v4e__settings_8h.html#4de068ec2e75b3c3dd7aaa1bb106edbba0bf359d1532e2a93109ed8b94bfca77" title="used together with sei.frame_packing flags. Force encoder to perform actual packing...">ENC_FRAME_PACKING</a>; 
        }
    }


    <span class="comment">// open input &amp; output files</span>
    rc = openFiles();
    <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> -1;

    <span class="comment">// application MUST provide release frame callback in order to work with</span>
    <span class="comment">// v4e_set_frame_ex() function</span>
    <span class="keywordflow">if</span> (use_async_feed)
    {
        frame_release_local.<a class="code" href="structv4__frame__release__t.html#00f7d04140448c72380b4c1c11fccc4d" title="application context for frame release callback;">context</a> = NULL;
        frame_release_local.<a class="code" href="structv4__frame__release__t.html#be6865130f4c1c28b1fc4689b2b5b4a6" title="frame release callback function;">callback</a> = release_raw_frame;
        frame_release = &amp;frame_release_local;
    }

    <span class="comment">// optional asynchronous NAL receive function</span>
    <span class="keywordflow">if</span> (use_async_receive)
    {
        nal_receive_local.<a class="code" href="structv4__receive__nal__t.html#50df277901daeba951e8be285c1c7aff" title="application context for receive nal callback;">context</a> = NULL;
        nal_receive_local.<a class="code" href="structv4__receive__nal__t.html#faae804787edfae1ee00167968182b60" title="receive nal callback function;">callback</a> = receive_nal_callback;
        nal_receive = &amp;nal_receive_local;
    }

<span class="preprocessor">#ifdef _CRT_DEBUG_</span>
<span class="preprocessor"></span>    _CrtMemCheckpoint(&amp;_ms1);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    settings.<a class="code" href="structv4e__settings__t.html#60910d442ddcafa5622b39e6bfa92deb">ext_data_string</a> = ext_data_string;
    rc = <a class="code" href="group__enc__func.html#g1e1356adaa4568c35ee17aeb4e9e7c50" title="Extended version of v4e_open() Create a new encoder instance.">v4e_open_ex</a>(&amp;handle, &amp;settings, frame_release, nal_receive);
    <span class="keywordflow">if</span> (rc &gt; <a class="code" href="group__return__codes.html#gb9dfadfbdfd9326b6a3b31988cd73957" title="Everything is OK.">VSSH_OK</a>)
    {
        verbose_print(0, <span class="stringliteral">"Warning: v4e_open_ex(): %d [%s]\n"</span>, rc, <a class="code" href="v4__types_8h.html#02e6cdb9da96a1559dfe16f35656d4a6">v4_error_text</a>(rc));
    }
    <span class="keywordflow">if</span> (rc &lt; <a class="code" href="group__return__codes.html#gb9dfadfbdfd9326b6a3b31988cd73957" title="Everything is OK.">VSSH_OK</a>)
    {
        verbose_print(0, <span class="stringliteral">"Error: v4e_open_ex(): %d [%s]\n"</span>, rc, <a class="code" href="v4__types_8h.html#02e6cdb9da96a1559dfe16f35656d4a6">v4_error_text</a>(rc));
        <span class="keywordflow">return</span> -3;
    }
    <a class="code" href="group__enc__func.html#g3d8f56cfdc6e56e0bcfaaee9707816eb" title="Fill given settings structure with actual encoder settings;.">v4e_get_current_settings</a>(handle, &amp;actual_settings);
    dump_encoder_settings(&amp;actual_settings, verbose);
    <span class="keywordflow">if</span> (dualpass_before(handle, &amp;actual_settings) &lt; <a class="code" href="group__return__codes.html#gb9dfadfbdfd9326b6a3b31988cd73957" title="Everything is OK.">VSSH_OK</a>)
    {
        <span class="keywordflow">return</span> -1;
    }

    <span class="comment">// prepare frame buffers with actual encoder settings </span>
    init_raw_frames(&amp;settings);

    <span class="keywordflow">if</span> (change_bitrate_period &gt; 0)
    {
        enc_change_bitrate(handle, &amp;settings, 100);
    }

    <span class="comment">// Multi-stream mode support</span>
    rc = multistream_init(&amp;actual_settings);
    <span class="keywordflow">if</span> (rc != 0) <span class="keywordflow">return</span> -1;

    num_frame = 0;
    total_frames = 0;
    total_samples = 0;
    total_bytes = 0;
    skip_counter = frame_skip;

    eof = 0;
    eos = 0;

<span class="preprocessor">#ifdef VSS_MB_TYPES_DUMP</span>
<span class="preprocessor"></span>    {
        g_dbg_num_layers = 0;
        g_num_b_frames = settings.<a class="code" href="structv4e__settings__t.html#86073d524a713c1166821c05d4c9635b" title="GOP settings;.">gop</a>.<a class="code" href="structgop__settings__t.html#238b886f9c0eb8205b1f715ba180292a" title="number of B-frames (0=disable);">bframes</a>;
<span class="preprocessor">#ifdef SVC_EXTENSION</span>
<span class="preprocessor"></span>        g_dbg_num_layers = settings.<a class="code" href="structv4e__settings__t.html#0eb9ab59c4fc040a3d4710b5ccfe617d" title="svc encoding settings">svc</a>.<a class="code" href="structsvc__settings__t.html#b9a25fb28ebf4cce9e1d69d9f2ea52b7" title="number of svc-layers (0 means no SVC)">num_layers</a> + 1;
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>        assert (g_dbg_num_layers &lt;= 5);
    }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="comment">// skip to frame_start position...</span>
    raw_frame = get_raw_frame(0);
    <span class="keywordflow">for</span> (i = 0; i&lt;frame_start; i++)
    {
        rc = readNextRawFrame(0, 0, raw_frame);
    }
    <span class="comment">// preload raw frames</span>
    preloadInit();

    <a class="code" href="v4timer_8h.html#7b8ab79df77b57475a5494f5f81c3bd9">timer_init</a>();
    timer_start(&amp;start_time);
    <span class="comment">// main encoding cycle</span>
    <span class="keywordflow">for</span> (i = 0; !eos; i++)
    {
        <span class="keywordflow">if</span> (!eof)
        {
            <span class="comment">// select next input frame from array</span>
            raw_frame = get_raw_frame(i);
            <span class="comment">// read next input raw frame and assign eof (end of file) flag</span>
            <span class="keywordflow">for</span> (again=1; again&gt;0; again--)
            {
                rc = readNextRawFrame(1, total_frames, raw_frame);
                <span class="keywordflow">if</span> ((rc != 0) || ((max_frames &gt; 0) &amp;&amp; (num_frame &gt;= max_frames)))
                {
                    eof = 1;
                    <span class="keywordflow">if</span> (forever  &gt; 0) forever -= 1;
                    <span class="keywordflow">if</span> (forever != 0)
                    {
                        rewindInput();
                        verbose_print(2, <span class="stringliteral">"*** rewind (%d)\n"</span>, forever);
                        eof = 0;
                        num_frame = 0;
                        again += 1;
                    }
                }
            }
            <span class="keywordflow">if</span> (eof)
            {
                <span class="comment">// signal encoder end of sequence</span>
                <a class="code" href="group__enc__func.html#g5d17bfa8acdf3f8419d94560a351daf3" title="This function signals encoder to process all the pending frames and return all NAL...">v4e_set_flush</a>(handle);
            }
            <span class="keywordflow">else</span>
            {
                <span class="keywordflow">if</span> ((frame_skip &gt; 0) &amp;&amp; (skip_counter &gt; 0))
                {
                    skip_counter -= 1;
                    verbose_print(2, <span class="stringliteral">"%4d: *** skip ***\n"</span>, total_frames);
                }
                <span class="keywordflow">else</span>
                {
                    skip_counter = frame_skip;
                    <span class="comment">// assign media time and timestamp</span>
                    raw_frame-&gt;vp_views[0].mediatime = -1 - i;
                    raw_frame-&gt;vp_views[0].timestamp = calc_timestamp(&amp;settings, total_frames);

                    <span class="comment">// send raw frame to encoder</span>
                    feed_raw_frame(handle, raw_frame, num_frame);
                    num_frame += 1;
                    verbose_print(2, <span class="stringliteral">"%4d: set frame ts=%6d \n"</span>, total_frames, (<span class="keywordtype">int</span>)(raw_frame-&gt;vp_views[0].timestamp/10000));
                    <span class="comment">//verbose_print(2, "%4d: set vp_frame ts=%6d \n", total_frames, (int)(raw_frame-&gt;vp_views[0].timestamp/10000));</span>
                }
                total_frames++;
                <span class="keywordflow">if</span> ((change_bitrate_period &gt; 0) &amp;&amp; (num_frame % change_bitrate_period == 0))
                {
                    enc_change_bitrate(handle, &amp;settings, change_bitrate_ratio);
                }
            }
        }
        <span class="comment">// note: async receive will enable "eos" flag externally</span>
        <span class="keywordflow">if</span> (!use_async_receive)
        {
            <span class="comment">// extract synchronously all the NAL units on every input frame</span>
            <span class="comment">// note: NAL units come in RBSP format but without start codes</span>
            <span class="keywordflow">for</span>(;;)
            {
                <span class="comment">// receive next NAL unit (if ready)</span>
                rc = <a class="code" href="group__enc__func.html#gc97625b168e1cb29f331cb73ea1c81da" title="The same as v4e_get_nal_ex(handle, pms, 0).">v4e_get_nal</a>(handle, &amp;ms);

                <span class="comment">// VSSH_WARN_EOS is a special code signaling that it is the last NAL unit</span>
                <span class="comment">// produced after v4e_set_flush()</span>
                <span class="keywordflow">if</span> (rc == <a class="code" href="group__return__codes.html#g5f07d3b52ddde66565a1f6c6de8f578f" title="Warning: end of stream.">VSSH_WARN_EOS</a>) eos = 1;
                <span class="keywordflow">if</span> (rc != <a class="code" href="group__return__codes.html#gb9dfadfbdfd9326b6a3b31988cd73957" title="Everything is OK.">VSSH_OK</a>) <span class="keywordflow">break</span>;

                on_nal_unit(ms);
            }
        }
    } <span class="comment">// while(!eos)</span>
    delta = timer_delta(&amp;start_time);
    total_ms = timer_delta_ms(delta);

    verbose_print(0, <span class="stringliteral">"%20s: %d\n"</span>, <span class="stringliteral">"total frames"</span>, total_frames);
    verbose_print(0, <span class="stringliteral">"%20s: %d\n"</span>, <span class="stringliteral">"total time, ms"</span>, total_ms);
    <span class="keywordflow">if</span> (total_ms &gt; 0)
    verbose_print(0, <span class="stringliteral">"%20s: %d\n"</span>, <span class="stringliteral">"total speed, fps"</span>, (total_frames*1000 + total_ms/2)/total_ms);
    {
        uint32_t stream_length_ms, time_scale_ms;
        stream_length_ms = 0;
        <span class="keywordflow">if</span> (actual_settings.<a class="code" href="structv4e__settings__t.html#86073d524a713c1166821c05d4c9635b" title="GOP settings;.">gop</a>.<a class="code" href="structgop__settings__t.html#3b8273f968d83a8032a075adf3f7c751" title="time scale (field_rate = time_scale/num_units);">time_scale</a> &gt; 0 &amp;&amp; settings.<a class="code" href="structv4e__settings__t.html#5b0cff9196a4141b810be5a8726ab328" title="avc intra class: 0 - avc intra is off, 50 - class 50, 100 - class 100">avc_intra_class</a> == 0)
        {
            <span class="keywordflow">if</span> (settings.<a class="code" href="structv4e__settings__t.html#5b0cff9196a4141b810be5a8726ab328" title="avc intra class: 0 - avc intra is off, 50 - class 50, 100 - class 100">avc_intra_class</a> == 0)
                time_scale_ms = (actual_settings.<a class="code" href="structv4e__settings__t.html#86073d524a713c1166821c05d4c9635b" title="GOP settings;.">gop</a>.<a class="code" href="structgop__settings__t.html#3b8273f968d83a8032a075adf3f7c751" title="time scale (field_rate = time_scale/num_units);">time_scale</a> + 1000) / 2000;
            <span class="keywordflow">else</span>
            {
                <span class="keywordflow">if</span> (actual_settings.<a class="code" href="structv4e__settings__t.html#86073d524a713c1166821c05d4c9635b" title="GOP settings;.">gop</a>.<a class="code" href="structgop__settings__t.html#3b8273f968d83a8032a075adf3f7c751" title="time scale (field_rate = time_scale/num_units);">time_scale</a> == 50 || actual_settings.<a class="code" href="structv4e__settings__t.html#86073d524a713c1166821c05d4c9635b" title="GOP settings;.">gop</a>.<a class="code" href="structgop__settings__t.html#3b8273f968d83a8032a075adf3f7c751" title="time scale (field_rate = time_scale/num_units);">time_scale</a> == 100)
                    time_scale_ms = actual_settings.<a class="code" href="structv4e__settings__t.html#86073d524a713c1166821c05d4c9635b" title="GOP settings;.">gop</a>.<a class="code" href="structgop__settings__t.html#3b8273f968d83a8032a075adf3f7c751" title="time scale (field_rate = time_scale/num_units);">time_scale</a> / 2;
                <span class="keywordflow">else</span>
                    time_scale_ms = (actual_settings.<a class="code" href="structv4e__settings__t.html#86073d524a713c1166821c05d4c9635b" title="GOP settings;.">gop</a>.<a class="code" href="structgop__settings__t.html#3b8273f968d83a8032a075adf3f7c751" title="time scale (field_rate = time_scale/num_units);">time_scale</a> + 1000) / 2000;
            }
            stream_length_ms = total_frames * actual_settings.<a class="code" href="structv4e__settings__t.html#86073d524a713c1166821c05d4c9635b" title="GOP settings;.">gop</a>.<a class="code" href="structgop__settings__t.html#3d8b81693cfeade850616e3b0f5c825b" title="num units per tick;">num_units</a> / time_scale_ms;
        }
        <span class="keywordflow">if</span> (stream_length_ms &gt; 0)
        {
            uint32_t bitrate = (uint32_t)(total_bytes * 8 / stream_length_ms);
            verbose_print(0, <span class="stringliteral">"%20s: %u \n"</span>, <span class="stringliteral">"stream length, ms"</span>, (uint32_t)stream_length_ms);
            verbose_print(0, <span class="stringliteral">"%20s: %u \n"</span>, <span class="stringliteral">"total bitrate, kbps"</span>, bitrate);
        }
    }

    <span class="comment">// release encoder instance</span>
    dualpass_after(handle, &amp;actual_settings);
    <a class="code" href="group__enc__func.html#g614215be21ac702d8bbd1a28c6621421" title="This function will impose flush event if not yet flushed to release output thread...">v4e_close</a>(handle);

    preloadClose();

<span class="preprocessor">#ifdef _CRT_DEBUG_</span>
<span class="preprocessor"></span>    _CrtMemCheckpoint(&amp;_ms2);
    _CrtMemDifference(&amp;_ms3, &amp;_ms1, &amp;_ms2);
    _CrtMemDumpStatistics(&amp;_ms3);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="comment">// release input raw frames</span>
    free_raw_frames();

    <span class="comment">// close files</span>
    closeFiles();

    <span class="comment">// Close multi-stream files</span>
    multistream_close();

<span class="preprocessor">#ifdef _CRT_DEBUG_</span>
<span class="preprocessor"></span>    _CrtDumpMemoryLeaks();
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
    <span class="keywordflow">return</span> 0;
}
</pre></div> </div>

<!-- footer.html -->
	<hr>

	<p style="font-size: smaller; text-align: right">
		&#169 <a href="http://www.vsofts.com/" target="_blank">Vanguard Software Solutions Inc</a> 1995-2011 - All rights reserved.
	</p>

	</body>
</html>
